@page "/occupants"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IOccupantRepository OccupantService
@inject IEmployeeRepository EmployeeService
@inject IRoomRepository RoomService
@inject IFileService FileService
@inject IOccupantHistoryRepository HistoryService
@inject ToastService ToastService


<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-blue-600 to-blue-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
            <div class="bg-white/20 rounded-full p-3"><i class="fas fa-users fa-2x"></i></div>
            <div>
                <h2 class="text-lg font-semibold">Total Occupants</h2>
                <p class="text-2xl font-bold">@Occupants?.Count()</p>
            </div>
        </div>
        <div class="bg-gradient-to-br from-green-600 to-green-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
            <div class="bg-white/20 rounded-full p-3"><i class="fas fa-check-circle fa-2x"></i></div>
            <div>
                <h2 class="text-lg font-semibold">Active</h2>
                <p class="text-2xl font-bold">@Occupants?.Count(u => u.DepartedAt == null)</p>
            </div>
        </div>
        <div class="bg-gradient-to-br from-red-600 to-red-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
            <div class="bg-white/20 rounded-full p-3"><i class="fas fa-user-slash fa-2x"></i></div>
            <div>
                <h2 class="text-lg font-semibold">Inactive</h2>
                <p class="text-2xl font-bold">@Occupants?.Count(u => u.DepartedAt != null)</p>
            </div>
        </div>
        <div class="bg-gradient-to-br from-yellow-600 to-yellow-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
            <div class="bg-white/20 rounded-full p-3"><i class="fas fa-exchange-alt fa-2x"></i></div>
            <div>
                <h2 class="text-lg font-semibold">Total Transfer</h2>
                <p class="text-2xl font-bold">@Occupants?.Count(u => u.DepartedAt == null)</p>
            </div>
        </div>
</div>


<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 mt-8">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 border-b pb-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Occupant Management</h2>
            <p class="text-gray-500 mt-1">Manage occupant check-in, check-out, and transfers.</p>
        </div>
        <div class="flex items-center space-x-3 mt-4 md:mt-0 w-full md:w-auto">
            <div class="relative w-full md:w-64">
                <input value="@SearchTerm" @oninput="HandleSearchTermChange"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
                    placeholder="Search Occupant, NRP, Position, Rank, Building, Room..." />
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <button class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                @onclick="ShowAddModal">
                <i class="fas fa-plus"></i> Add Occupant
            </button>
        </div>
    </div>
    <div class="p-6 space-y-6">
    <div class="overflow-x-auto">
        @if (PagedOccupants != null && PagedOccupants.Any())
        {
            <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
                <thead class="bg-gradient-to-b from-red-700 to-black">
                    <tr>
                        <th class="px-4 py-2 text-white">Employee name</th>
                        <th class="px-4 py-2 text-white">NRP</th>
                        <th class="px-4 py-2 text-white">Phone</th>
                        <th class="px-4 py-2 text-white">Position</th>
                        <th class="px-4 py-2 text-white">Rank</th>
                        <th class="px-4 py-2 text-white">Arrived Date</th>
                        <th class="px-4 py-2 text-white">Departed Date</th>
                        <th class="px-4 py-2 text-white">Building</th>
                        <th class="px-4 py-2 text-white">Floor</th>
                        <th class="px-4 py-2 text-white">Room</th>
                        <th class="px-4 py-2 text-white">Status</th>
                        <th class="px-4 py-2 text-white">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var occupant in PagedOccupants)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">@occupant.Employee?.Name</td>
                            <td class="px-4 py-2">@occupant.Employee?.NRP</td>
                            <td class="px-4 py-2">@occupant.Employee?.Phone</td>
                            <td class="px-4 py-2">@occupant.Employee?.Position?.Name</td>
                            <td class="px-4 py-2">@occupant.Employee?.Rank?.Name</td>
                            <td class="px-4 py-2">@occupant.ArrivedAt.ToString("dd MMM yyyy")</td>
                            <td class="px-4 py-2">@occupant.DepartedAt?.ToString("dd MMM yyyy")</td>
                            <td class="px-4 py-2">@occupant.Room?.Building.Name</td>
                            <td class="px-4 py-2">@occupant.Room?.Floor</td>
                            <td class="px-4 py-2">@occupant.Room?.Name</td>
                            <td class="px-4 py-2">
                                <span class="@GetStatusClass(occupant.DepartedAt == null)">
                                    @(occupant.DepartedAt == null ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-4 py-2 space-x-2">
                                <button class="px-2 py-1 bg-blue-500 text-white rounded" 
                                        @onclick="async () => await ShowDetail(occupant)">
                                    Detail
                                </button>

                                <button class=@($"px-2 py-1 text-white rounded {(occupant.DepartedAt == null ? "bg-red-500 hover:bg-red-600" : "bg-gray-400 cursor-not-allowed")}")
                                        @onclick="()=>ShowCheckoutModal(occupant.Id)"
                                        disabled="@(occupant.DepartedAt != null)">
                                    Checkout
                                </button>

                                <button class=@($"px-2 py-1 text-white rounded {(occupant.DepartedAt == null ? "bg-yellow-500 hover:bg-yellow-600" : "bg-gray-400 cursor-not-allowed")}")
                                        @onclick="()=>ShowTransferModal(occupant.Id)"
                                        disabled="@(occupant.DepartedAt != null)">
                                    Transfer
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="flex flex-col items-center justify-center py-12 bg-white rounded-lg shadow-inner text-gray-500">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p class="text-lg font-medium">No Occupants found.</p>
            </div>
        }
    </div>

            @* --- PAGINATION --- *@
            @if (FilteredOccupants.Any() && TotalPages > 1)
            {
                <div class="mt-8 flex justify-between items-center p-4 bg-gray-50 rounded-xl shadow-inner">
                    <span class="text-sm text-gray-600">
                        Showing <strong>@((CurrentPage - 1) * PageSize + 1)</strong> to <strong>@(Math.Min(CurrentPage * PageSize, FilteredOccupants.Count))</strong> of <strong>@FilteredOccupants.Count</strong> entries
                    </span>
                    <div class="flex space-x-2">
                        <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == 1 ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                            @onclick="() => ChangePage(CurrentPage - 1)" disabled="@(CurrentPage == 1)">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        @for (int i = 1; i <= TotalPages; i++)
                        {
                            var pageNumber = i;
                            <button class="px-4 py-2 text-sm rounded-lg font-medium @(i == CurrentPage ? "bg-blue-600 text-white shadow-md" : "bg-white hover:bg-blue-50 border text-gray-700")"
                                @onclick="() => ChangePage(pageNumber)">@i</button>
                        }
                        <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == TotalPages ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                            @onclick="() => ChangePage(CurrentPage + 1)" disabled="@(CurrentPage == TotalPages)">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>



@* Modal Add/Edit Occupant *@
@if (ShowModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md overflow-y-auto max-h-screen">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            @if (AddStep == 1)
            {
                <div>
                    <label class="block mb-1">Enter NRP</label>
                    <div class="flex items-center gap-2">
                        <input class="flex-1 px-3 py-2 border rounded mt-1 disabled:bg-gray-100"
                            placeholder="NRP"
                            @bind="NRPInput"
                            @onkeyup="OnNRPEnter"
                            disabled="@isLoading" />

                        @if (isLoading)
                        {
                            <!-- Spinner -->
                            <div class="animate-spin border-2 border-t-transparent border-blue-500 rounded-full w-5 h-5"></div>
                        }
                        else
                        {
                            <button class="px-2" @onclick="SearchNRP">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        }
                    </div>
                </div>
            }

            else if (AddStep == 2)
            {
                <div class="flex flex-col items-center mb-4">
                    @* Photo *@
                    @if (PhotoByEmployee.TryGetValue(SelectedOccupant.EmployeeId, out var photos) && photos.Any())
                    {
                        <img src="@($"/secure-files/{photos.First().Path}")"
                            class="w-40 h-40 rounded-full mx-auto mb-4 object-cover" />
                    }
                    else
                    {
                        <div class="w-40 h-40 rounded-full bg-gray-200 mx-auto mb-4 flex items-center justify-center text-gray-500">
                            No Photo
                        </div>
                    }
                </div>
                <div class="space-y-2">
                    <div><b>NRP: @SelectedOccupant.Employee?.NRP</b</div>
                    <div>Name: @SelectedOccupant.Employee?.Name</div>
                    <div>Gender: @SelectedOccupant.Employee?.Gender</div>
                    <div>Phone: @SelectedOccupant.Employee?.Phone</div>
                    <div>Position: @SelectedOccupant.Employee?.Position?.Name</div>
                    <div>Rank: @SelectedOccupant.Employee?.Rank?.Name</div>
                </div>
            }
            else if (AddStep == 3)
            {
                <div class="space-y-2">
                    <label>Select Room</label>
                    <select class="w-full border rounded px-2 py-1" @bind="SelectedOccupant.RoomId">
                        <option value="">Select Room</option>
                        @foreach(var room in Rooms ?? new List<Room>())
                        {
                            <option value="@room.Id">@room.RoomNo</option>
                        }
                    </select>

                    @* <label>Upload Photo</label>
                    <InputFile OnChange="OnPhotoSelected" accept="image/*" />

                    <label>Upload Document</label>
                    <InputFile OnChange="OnDocumentSelected" accept=".pdf,.doc,.docx" /> *@
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-1">Photo</label>
                    <InputFile OnChange="OnPhotoSelected" accept="image/*" />
                    <p class="text-xs text-gray-500 text-red-500">Max 2 MB,Image *.jpg,.jpeg,.png </p>
                </div>

                <!-- Upload Dokumen PDF -->
                <div class="mb-4">
                    <label class="block font-semibold mb-1">Documents (.PDF) (Optional)</label>
                    <InputFile OnChange="OnDocsSelected" multiple accept="application/pdf" />
                    <p class="text-xs text-gray-500 text-red-500">Max 10 MB ,PDF Only</p>
                </div>
            }

            <div class="flex justify-end space-x-2 mt-4">
                @if(AddStep > 1)
                {
                    <button class="px-3 py-1 bg-gray-300 rounded" @onclick="()=>AddStep--">Back</button>
                }
                @if(AddStep == 2)
                {
                    <button class="px-3 py-1 bg-blue-600 text-white rounded" @onclick="NextStep">Next</button>
                }
                @if(AddStep == 3)
                {
                    <button class="px-3 py-1 bg-green-600 text-white rounded" @onclick="SaveOccupant">Save</button>
                }
                <button class="px-3 py-1 bg-red-500 text-white rounded" @onclick="()=>ShowModal=false">Close</button>
            </div>
        </div>
    </div>
}

@* Modal Detail Occupant *@
@if (ShowDetailModal && SelectedOccupant != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
            <div class="absolute inset-0 flex justify-center items-center pointer-events-none">
                <img src="assets/images/mock.png" 
                    class="max-w-[30%] max-h-[30%] opacity-30" 
                    alt="watermark">
            </div>
            <h2 class="text-xl font-bold mb-4 pb-2 border-b border-gray-300">Occupant Detail</h2>
            <div class="flex flex-col items-center mb-4">
                    @* Photo *@
                    @if (PhotoByEmployee.TryGetValue(SelectedOccupant.EmployeeId, out var photos) && photos.Any())
                    {
                        <img src="@($"/secure-files/{photos.First().Path}")"
                            class="w-40 h-40 rounded-full mx-auto mb-4 object-cover" />
                    }
                    else
                    {
                        <div class="w-40 h-40 rounded-full bg-gray-200 mx-auto mb-4 flex items-center justify-center text-gray-500">
                            No Photo
                        </div>
                    }
                </div>
            <div class="space-y-2">
                <div class="mt-4">
                    <h4 class="font-semibold mb-2 font-bold text-xl">Occupant Info</h4>
                    <ul class="list-disc ml-5 space-y-1">
                    <div class=" text-md font-semibold divide-y divide-gray-300 text-gray-700">

                        <div class="grid grid-cols-3 gap-2 py-2">
                            <div class="font-semibold">NRP</div>
                            <div class="font-semibold">@SelectedOccupant.Employee?.NRP</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 py-2">
                            <div class="font-semibold">Name</div>
                            <div>@SelectedOccupant.Employee?.Name</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 py-2">
                            <div class="font-semibold">Gender</div>
                            <div>@SelectedOccupant.Employee?.Gender</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 py-2">
                            <div class="font-semibold">Phone</div>
                            <div>@SelectedOccupant.Employee?.Phone</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 py-2">
                            <div class="font-semibold">Position</div>
                            <div>@SelectedOccupant.Employee?.Position?.Name</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 py-2">
                            <div class="font-semibold">Rank</div>
                            <div>@SelectedOccupant.Employee?.Rank?.Name</div>
                        </div>
                        <div class="grid grid-cols-3  py-2">
                            <div class="font-semibold">Status</div>
                            <div>
                                <span class="@GetStatusClass(SelectedOccupant.DepartedAt == null)">
                                    @(SelectedOccupant.DepartedAt == null ? "Active" : "Inactive")
                                </span>
                            </div>
                            
                        </div>

                    </div>
                    </ul>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Building Info</h4>
                    <ul class="list-disc ml-5 space-y-1">
                        <div class=" text-md font-semibold divide-y divide-gray-300 text-gray-700">

                            <div class="grid grid-cols-3 gap-2 py-2">
                                <div class="font-semibold">Building</div>
                                <div class="font-semibold">@SelectedOccupant.Room?.Building?.Name | @SelectedOccupant.Room?.Floor</div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 py-2">
                                <div class="font-semibold">Room</div>
                                <div>@SelectedOccupant.Room?.Name | @SelectedOccupant.Room?.RoomNo</div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 py-2">
                                <div class="font-semibold">Arrive Date</div>
                                <div>@SelectedOccupant.ArrivedAt.ToString("dd MMM yyyy")</div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 py-2">
                                <div class="font-semibold">Depature Date</div>
                                <div>@SelectedOccupant.DepartedAt?.ToString("dd MMM yyyy")</div>
                            </div>
                        </div>
                    </ul>
                </div>
                
                @if (PhotoByOccupant.TryGetValue(SelectedOccupant.Id, out var photoOcc) && photoOcc.Any())
                {
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Photo Attachment</h4>
                        <ul class="list-disc ml-5 space-y-1">
                            <div class="relative w-full flex justify-center">
                                <img src="@($"/secure-files/{photoOcc.First().Path}")"
                                    class="w-full h-48 rounded-md object-contain border" />
                                    <a href="@($"/secure-files/{photoOcc.First().Path}")" 
                                    download
                                    class="absolute top-2 right-2 bg-blue-600 text-white p-2 rounded-full shadow hover:bg-blue-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3" />
                                    </svg>
                                </a>
                            </div>
                        </ul>
                    </div>
                }
                @if (DocsByOccupant.TryGetValue(SelectedOccupant.Id, out var docs) && docs.Any())
                {
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Documents Attachment</h4>
                        <ul class="list-disc ml-5 space-y-1">
                            @foreach (var d in docs)
                            {
                                <li>
                                    <a href="@($"/secure-files/{d.Path}")" target="_blank" class="text-blue-600 hover:underline">@d.FileName</a>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <div class="flex justify-end mt-4">
                <button class="px-3 py-1 bg-red-500 text-white rounded" @onclick="()=>ShowDetailModal=false">Close</button>
            </div>
        </div>
    </div>
}

@* Modal Checkout *@
@if (ShowCheckoutModalFlag)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Checkout Occupant</h2>
            <label>Checkout Date:</label>
            <InputDate @bind-Value="CheckoutDate" class="w-full border rounded px-2 py-1 mb-4" />

            <label>Notes:</label>
            <InputTextArea @bind-Value="NotesAction"
                       class="w-full border rounded px-2 py-1 mb-4"
                       rows="3"
                       placeholder="Enter checkout notes..." />

            <div class="flex justify-end space-x-2">
                <button class="px-3 py-1 bg-gray-300 rounded" @onclick="()=>ShowCheckoutModalFlag=false">Cancel</button>
                <button class="px-3 py-1 bg-red-600 text-white rounded" @onclick="CheckoutOccupant">Checkout</button>
            </div>
        </div>
    </div>
}

@* Modal Transfer *@
@if (ShowTransferModalFlag)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Transfer Occupant</h2>
            <label>Select New Room:</label>
            <select class="w-full border rounded px-2 py-1 mb-4" @bind="TransferRoomId">
                <option value="">Select Room</option>
                @foreach(var room in Rooms ?? new List<Room>())
                {
                    <option value="@room.Id">@room.RoomNo</option>
                }
            </select>

            <InputTextArea @bind-Value="NotesAction"
                       class="w-full border rounded px-2 py-1 mb-4"
                       rows="3"
                       placeholder="Enter transfer notes..." />

            <div class="flex justify-end space-x-2">
                <button class="px-3 py-1 bg-gray-300 rounded" @onclick="()=>ShowTransferModalFlag=false">Cancel</button>
                <button class="px-3 py-1 bg-yellow-600 text-white rounded" @onclick="TransferOccupant">Transfer</button>
            </div>
        </div>
    </div>
}

<ToastContainer @ref="toastContainer" />

@code {
    private bool isLoading = false;
    private ToastContainer? toastContainer;
    private string SearchTerm { get; set; } = "";
    private List<Occupant>? Occupants;
    private List<Position> Positions = new();
    private List<Rank> Ranks = new();
    private List<Occupant> FilteredOccupants =>
        Occupants == null ? new List<Occupant>() :
        (string.IsNullOrEmpty(SearchTerm)
            ? Occupants
            : Occupants.Where(o =>
                (o.Employee?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
                (o.Employee?.Position?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
                (o.Employee?.NRP?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
                (o.Employee?.Rank?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
                (o.Room?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
                (o.Room?.Building?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true)
            ).ToList());

    private int CurrentPage = 1;
    private const int PageSize = 10;
    private int TotalPages => (int)Math.Ceiling(FilteredOccupants.Count / (double)PageSize);
    private List<Occupant> PagedOccupants =>
        FilteredOccupants.Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToList();

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
        }
    }

    private bool ShowModal = false;

    private void HandleSearchTermChange(ChangeEventArgs e)
    {
        SearchTerm = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }
    private string ModalTitle = "Add Occupant";
    private int AddStep = 1;
    private string? NRPInput;
    private Occupant SelectedOccupant = new();

    private List<Room>? Rooms;

    // Checkout
    private bool ShowCheckoutModalFlag = false;
    private int CheckoutOccupantId;
    private DateTime? CheckoutDate = DateTime.Today;

    // Transfer
    private bool ShowTransferModalFlag = false;
    private int TransferOccupantId;
    private string NotesAction = string.Empty;
    private int? TransferRoomId;

    // Detail
    private bool ShowDetailModal = false;

    private IReadOnlyList<IBrowserFile>? PendingUploads;
    private IBrowserFile? PendingPhoto;
    private IReadOnlyList<IBrowserFile>? PendingDocs;

    // Dictionaries untuk file
    private Dictionary<int, List<FileUpload>> PhotoByEmployee = new();
    private Dictionary<int, List<FileUpload>> DocsByOccupant = new();
    private Dictionary<int, List<FileUpload>> PhotoByOccupant = new();

    protected override async Task OnInitializedAsync()
    {
        Occupants = await OccupantService.GetAllAsync();
        Rooms = await RoomService.GetAllAsync();
        var allPhotos = await FileService.GetFilesByCategoryAsync("EmployeePhoto");
        PhotoByEmployee = allPhotos
            .GroupBy(f => f.OwnerId)
            .ToDictionary(g => g.Key, g => g.ToList());

        // Load photo
        var allPhotos2 = await FileService.GetFilesByCategoryAsync("OccupantPhoto");
        PhotoByOccupant = allPhotos2
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

        // Load documents
        var allDocs = await FileService.GetFilesByCategoryAsync("OccupantDocs");
        DocsByOccupant = allDocs
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

    }

    private void ShowAddModal()
    {
        ModalTitle = "Add Occupant";
        ShowModal = true;
        AddStep = 1;
        SelectedOccupant = new();
        NRPInput = "";
    }

    private async Task OnNRPEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(NRPInput) && !isLoading)
        {
            
            try
            {
                isLoading = true;

                var emp = await EmployeeService.GetByNRPAsync(NRPInput);
                

                if (emp != null)
                {
                    var occ = await OccupantService.GetByEmployeeIdAsync(emp.Id);
                    if(occ != null && occ?.DepartedAt == null)
                    {
                        await ToastService.ShowWarning("Employee is Occupant Active!");
                        return;
                    }
                    SelectedOccupant.EmployeeId = emp.Id;
                    SelectedOccupant.Employee = emp;
                    AddStep = 2;
                }
                else
                {
                    await ToastService.ShowWarning("NRP not found!");
                }
            }
            catch (Exception ex)
            {
                await ToastService.ShowError($"Error: {ex.Message}");
            }
            finally
            {
                isLoading = false;
            }
        }
    }

    private async Task SearchNRP()
    {
        if (!string.IsNullOrWhiteSpace(NRPInput) && !isLoading)
        {
            await OnNRPEnter(new KeyboardEventArgs { Key = "Enter" });
        }
    }

    private void NextStep()
    {
        if(AddStep < 3) AddStep++;
    }

    private async Task SaveOccupant()
    {
        
        await OccupantService.AddAsync(SelectedOccupant);
        if (PendingPhoto != null)
            await FileService.SaveFileAsync(PendingPhoto, "OccupantPhoto", SelectedOccupant.Id);

        // Simpan dokumen
        if (PendingDocs?.Count > 0)
        {
            foreach (var doc in PendingDocs)
                await FileService.SaveFileAsync(doc, "OccupantDocs", SelectedOccupant.Id);
        }

        // Load photo
        var allPhotos2 = await FileService.GetFilesByCategoryAsync("OccupantPhoto");
        PhotoByOccupant = allPhotos2
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

        // Load documents
        var allDocs = await FileService.GetFilesByCategoryAsync("OccupantDocs");
        DocsByOccupant = allDocs
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

        var history = new OccupantHistory
            {
                OccupantId = SelectedOccupant.Id,
                Action = "CheckIn",
                RoomId = SelectedOccupant.RoomId,
                Notes = $"CheckIn room {SelectedOccupant.Room?.Name}"
            };
            await HistoryService.AddAsync(history);

    await ToastService.ShowSuccess("Occupant saved!");
        Occupants = await OccupantService.GetAllAsync();
        ShowModal = false;
    }

    private async Task ShowDetail(Occupant occ)
    {
        SelectedOccupant = occ;

        var allPhotos2 = await FileService.GetFilesByCategoryAsync("OccupantPhoto");
        PhotoByOccupant = allPhotos2.GroupBy(f => f.OwnerId)
                                    .ToDictionary(g => g.Key, g => g.ToList());

        var allDocs = await FileService.GetFilesByCategoryAsync("OccupantDocs");
        DocsByOccupant = allDocs.GroupBy(f => f.OwnerId)
                                .ToDictionary(g => g.Key, g => g.ToList());

        ShowDetailModal = true;
    }


    private void ShowCheckoutModal(int id)
    {
        CheckoutOccupantId = id;
        CheckoutDate = DateTime.Today;
        ShowCheckoutModalFlag = true;
    }

    private async Task CheckoutOccupant()
    {
        if (CheckoutOccupantId == 0 || CheckoutDate == null)
        return;

        // ambil fresh dari DbContext
        var occ = await OccupantService.GetByIdAsync(CheckoutOccupantId);
        if(occ?.DepartedAt != null )
        {
            await ToastService.ShowWarning("Occupant InActive!");
            return;
        }
        if (occ != null)
        {
            occ.DepartedAt = CheckoutDate.Value;
            await OccupantService.UpdateAsync(occ);
            var history = new OccupantHistory
            {
                OccupantId = occ.Id,
                Action = "Checkout",
                RoomId = occ.RoomId,
                Notes = String.IsNullOrEmpty(NotesAction) ? $"Checkout from room {occ.Room?.Name}" : $"Checkout from room {occ.Room?.Name} - {NotesAction}"
            };
            await HistoryService.AddAsync(history);
            await ToastService.ShowInfo("Occupant checked out!");
            Occupants = await OccupantService.GetAllAsync(); // refresh
        }
        ShowCheckoutModalFlag = false;
    }

    private void ShowTransferModal(int id)
    {
        TransferOccupantId = id;
        TransferRoomId = null;
        ShowTransferModalFlag = true;
    }

    private async Task TransferOccupant()
    {
        if(TransferRoomId != null)
        {
            var occ = await OccupantService.GetByIdAsync(SelectedOccupant.Id);
            if(occ != null)
            {
                var oldRoomName = SelectedOccupant.Room?.Name;
                var newRoom = await RoomService.GetByIdAsync(TransferRoomId.Value);
                occ.RoomId = TransferRoomId.Value;
                occ.ArrivedAt = DateTime.Now;
                await OccupantService.UpdateAsync(occ); // aman karena instance baru
                var history = new OccupantHistory
                {
                    OccupantId = occ.Id,
                    Action = "Transfer",
                    RoomId = occ.RoomId,
                    Notes = String.IsNullOrEmpty(NotesAction) ? $"Transfer from room {oldRoomName} to {newRoom?.Name}" : $"Transfer from room {oldRoomName} to {newRoom?.Name} - {NotesAction}"
                };
                await HistoryService.AddAsync(history);
                await ToastService.ShowInfo("Occupant transferred!");
                Occupants = await OccupantService.GetAllAsync(); // refresh UI
                NotesAction = string.Empty;
            }
        }
        ShowTransferModalFlag = false;
    }

    private void OnPhotoSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file.ContentType.StartsWith("image/"))
            PendingPhoto = file;
        else
            ToastService.ShowWarning("Photo File Ext. Not Allowed!");
    }

    private void OnDocsSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles()
        .Where(f => f.ContentType == "application/pdf")
        .ToList();
        if (files.Any())
            PendingDocs = files;
        else
            ToastService.ShowWarning("Only PDF Allowed!");
    }

    private string GetStatusClass(bool active) =>
    active ? "px-2 py-1 text-md bg-green-600 text-white rounded-full"
    : "px-2 py-1 text-md bg-red-600 text-white rounded-full";
}
