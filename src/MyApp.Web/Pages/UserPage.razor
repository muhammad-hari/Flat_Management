@page "/users"
@using System.ComponentModel.DataAnnotations
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IUserRepository UserService
@inject IPositionRepository PositionService
@inject IRoleRepository RoleService
@inject IUserTypeRepository UserTypeService

<div class="bg-gradient-to-b from-red-700 to-black rounded-lg shadow-sm p-6">
    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
        <h2 class="text-2xl font-semibold text-gray-800">Users Management</h2>
        <p class="text-gray-600 mt-1">Manage User, Role and Privilege</p>
    </div>
</div>

<div class="p-6 space-y-6">
    <!-- Summary Card -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-blue-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Users</h2>
            <p class="text-2xl font-bold">@Users?.Count()</p>
        </div>
        <div class="bg-green-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Active</h2>
            <p class="text-2xl font-bold">@Users?.Count(u => u.IsActive)</p>
        </div>
        <div class="bg-red-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Inactive</h2>
            <p class="text-2xl font-bold">@Users?.Count(u => !u.IsActive)</p>
        </div>
        <div class="bg-purple-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Roles</h2>
            <p class="text-2xl font-bold">@Users?.Select(u => u.Role).Distinct().Count()</p>
        </div>
    </div>

    <!-- Search & Add -->
    <div class="flex justify-between items-center">
        <input type="text" placeholder="Search user..." @bind="SearchTerm"
            class="px-4 py-2 w-1/3 rounded-lg border border-green-800 focus:ring-2 focus:ring-blue-500" />
        <button @onclick="AddUser" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
            + Add User
        </button>
    </div>

    <!-- User Table -->
    <div class="overflow-x-auto mt-4">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
            <thead class="bg-gradient-to-b from-red-700  to-black">
                <tr>
                    <th class="px-4 py-2 text-white">Username</th>
                    <th class="px-4 py-2 text-white">Email</th>
                    <th class="px-4 py-2 text-white">Phone</th>
                    <th class="px-4 py-2 text-white">Position</th>
                    <th class="px-4 py-2 text-white">Role</th>
                    <th class="px-4 py-2 text-white">Status</th>
                    <th class="px-4 py-2 text-white">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredUsers.Any())
                {
                    @foreach (var user in FilteredUsers)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">@user.UserName</td>
                            <td class="px-4 py-2">@user.Email</td>
                            <td class="px-4 py-2">@user.Phone</td>
                            <td class="px-4 py-2">@user.Position?.Name</td>
                            <td class="px-4 py-2">@user.Role?.RoleName</td>
                            <td class="px-4 py-2">
                                <span class="@GetStatusClass(user.IsActive)">
                                    @(user.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap space-x-2">
                                <button class="px-2 py-1 bg-green-500 text-white rounded text-sm"
                                    @onclick="() => ShowDetail(user)">Detail</button>
                                <button class="px-2 py-1 bg-blue-500 text-white rounded text-sm"
                                    @onclick="() => EditUser(user)">Edit</button>
                                <button class="px-2 py-1 bg-red-500 text-white rounded text-sm"
                                    @onclick="() => ConfirmDelete(user.Id, user.UserName)">Delete</button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="p-8">
                            <div class="flex flex-col items-center justify-center text-gray-400">
                                <img src="assets/images/empty-data.png" alt="No data" class="h-32 w-32 mb-4" />
                                <div>No Data</div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Add/Edit/Detail -->
@if (ShowModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg  overflow-hidden">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            @if (ModalMode == "Detail")
            {
                <div class="flex flex-col items-center mb-4">
                    @if (SelectedUser.PhotoData != null)
                    {
                        var base64 = Convert.ToBase64String(SelectedUser.PhotoData);
                        <img src="data:image/png;base64,@base64" class="w-40 h-40 rounded-full mb-4" />
                    }
                    else
                    {
                        <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-gray-500">No Photo</span>
                        </div>
                    }
                </div>

                <div class="grid grid-cols-2 gap-2 text-gray-700">
                    <div class="font-semibold">UserName</div>
                    <div>@SelectedUser.UserName</div>

                    @* <div class="font-semibold">Gender</div>
                    <div>@SelectedUser.Gender</div> *@

                    <div class="font-semibold">Date of Birth</div>
                    <div>@SelectedUser.DateOfBirth.ToString("dddd, dd MMMM yyyy")</div>

                    <div class="font-semibold">Email Address</div>
                    <div>@SelectedUser.Email</div>

                    <div class="font-semibold">Phone Number</div>
                    <div>@SelectedUser.Phone</div>

                    <div class="font-semibold">Address</div>
                    <div>@SelectedUser.Address</div>

                    <div class="font-semibold">Role</div>
                    <div>@SelectedUser.Role?.RoleName</div>

                    <div class="font-semibold">Position</div>
                    <div>@SelectedUser.Position?.Name</div>

                    <div class="font-semibold">Status</div>
                    <div>
                        <span class="@GetStatusClass(SelectedUser.IsActive)">
                            @(SelectedUser.IsActive ? "Active" : "Inactive")
                        </span>
                    </div>

                    <div class="font-semibold">Created Date</div>
                    <div>@SelectedUser.CreatedAt.ToString("dddd, dd MMMM yyyy")</div>
                </div>
                <div class="flex justify-end space-x-2 gap-2 mt-4">
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded" @onclick="CloseModal">Close</button>
                </div>
            }
            else
            {
                <!-- EditForm dengan DataAnnotations -->
                <EditForm Model="@SelectedUser" OnValidSubmit="SaveUser">
                    <DataAnnotationsValidator />
                    @* <ValidationSummary /> *@

                    <InputText class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.UserName"
                        placeholder="Username" />
                    <ValidationMessage For="@(() => SelectedUser.UserName)" />

                    <InputText class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.Email"
                        placeholder="Email" />
                    <ValidationMessage For="@(() => SelectedUser.Email)" />

                    <InputText class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.Phone"
                        placeholder="Phone" />
                    <ValidationMessage For="@(() => SelectedUser.Phone)" />

                    <InputText class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.NRP"
                        placeholder="User NRP" />

                    <InputText class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.Address"
                        placeholder="Address" />

                    <InputText class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="Password" placeholder="Password"
                        type="password" />

                    <div class="font-semibold">Position</div>
                    <InputSelect class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.PositionId">
                        <option value="">Select Position</option>
                        @foreach (var pos in Positions)
                        {
                            <option value="@pos.Id">@pos.Name</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => SelectedUser.PositionId)" />

                    <div class="font-semibold">Role</div>
                    <InputSelect class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.RoleId">
                        <option value="">Select Role</option>
                        @foreach (var role in Roles)
                        {
                            <option value="@role.Id">@role.RoleName</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => SelectedUser.RoleId)" />

                    <div class="font-semibold">User Type</div>
                    <InputSelect class="w-full mb-2 px-3 py-2 border rounded" @bind-Value="SelectedUser.UserTypeId">
                        <option value="">Select User Type</option>
                        @foreach (var type in UserTypes)
                        {
                            <option value="@type.Id">@type.TypeName</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => SelectedUser.UserTypeId)" />

                    <label class="flex items-center space-x-2 mb-2">
                        <InputCheckbox @bind-Value="SelectedUser.IsActive" />
                        <span>Active</span>
                    </label>

                    @* <InputFile OnChange="OnFileChange" class="mb-2" /> *@

                    <div class="flex justify-end space-x-2">
                        <button type="button" class="px-4 py-2 bg-red-600 text-white rounded"
                            @onclick="CloseModal">Close</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
}

<!-- Confirm Delete Modal -->
@if (ShowConfirmModal)
{
    <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Delete</h3>
            <p class="text-gray-700 mb-6">@ConfirmMessage</p>
            <div class="flex justify-end space-x-3">
                <button class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg" @onclick="CancelDelete">Cancel</button>
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"
                    @onclick="DeleteConfirmed">Delete</button>
            </div>
        </div>
    </div>
}

<ToastContainer @ref="toastContainer" />

@code {
    private ToastContainer? toastContainer;
    private List<User> Users = new();
    private List<Position> Positions = new();
    private List<Role> Roles = new();
    private List<UserType> UserTypes = new();

    private string SearchTerm = "";
    private bool ShowModal;
    private string ModalTitle = "";
    private string ModalMode = "";
    private User SelectedUser = new();
    private string Password = "";
    private bool ShowConfirmModal;
    private string ConfirmMessage = "";
    private int UserIdToDelete;

    protected override async Task OnInitializedAsync()
    {
        Users = await UserService.GetAllAsync();
        Positions = await PositionService.GetAllAsync();
        Roles = await RoleService.GetAllAsync();
        UserTypes = await UserTypeService.GetAllAsync();
    }

    private IEnumerable<User> FilteredUsers =>
    Users.Where(u => string.IsNullOrWhiteSpace(SearchTerm) ||
    u.UserName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    private string GetStatusClass(bool active) =>
    active ? "px-2 py-1 text-xs bg-green-200 text-green-800 rounded-full"
    : "px-2 py-1 text-xs bg-red-200 text-red-800 rounded-full";

    private void ShowDetail(User user)
    {
        SelectedUser = user;
        ModalTitle = "User Detail";
        ModalMode = "Detail";
        ShowModal = true;
    }

    private void AddUser()
    {
        SelectedUser = new User(); // default IsActive = false (lihat model)
        Password = "";
        ModalTitle = "Add User";
        ModalMode = "Add";
        ShowModal = true;
    }

    private void EditUser(User user)
    {
        SelectedUser = user;
        Password = "";
        ModalTitle = "Edit User";
        ModalMode = "Edit";
        ShowModal = true;
    }

    private void CloseModal() => ShowModal = false;

    @* private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream(10_000_000).ReadAsync(buffer);
        SelectedUser.PhotoData = buffer;
    } *@

    private void ConfirmDelete(int id, string name)
    {
        UserIdToDelete = id;
        ConfirmMessage = $"Are you sure you want to delete user \"{name}\"?";
        ShowConfirmModal = true;
    }

    private void CancelDelete() => ShowConfirmModal = false;

    private async Task DeleteConfirmed()
    {
        try
        {
            var user = await UserService.GetByIdAsync(UserIdToDelete);
            if (user == null)
            {
                toastContainer?.ShowToast("User not found!", "error");
                ShowConfirmModal = false;
                return;
            }
            await UserService.DeleteAsync(UserIdToDelete);
            Users = await UserService.GetAllAsync();
            ShowConfirmModal = false;
        }
        catch (Exception ex)
        {
            toastContainer?.ShowToast($"Error: {ex.Message}", "error");
            ShowConfirmModal = false;
            return;
        }

        toastContainer?.ShowToast("User berhasil dihapus!", "success");
    }

    private async Task SaveUser()
    {
        try
        {
            @* ValidationContext? context = new ValidationContext(SelectedUser);
            List<ValidationResult>? results = new List<ValidationResult>();
            if (!Validator.TryValidateObject(SelectedUser, context, results, validateAllProperties: true))
            {
                foreach (ValidationResult validationResult in results)
                {
                    toastContainer?.ShowToast(validationResult.ErrorMessage ?? "Validation error", "error");
                }
                return;
            }

            if (ModalMode == "Add" && string.IsNullOrWhiteSpace(Password))
            {
                toastContainer?.ShowToast("Password is required for new users.", "error");
                return;
            } *@



            if (ModalMode == "Add")
            {
                if (!string.IsNullOrEmpty(Password))
                {
                    SelectedUser.PasswordHash = BCrypt.Net.BCrypt.HashPassword(Password);
                }
                else
                {
                    toastContainer?.ShowToast("Password is required for new users.", "error");
                    return;
                }
                await UserService.AddAsync(SelectedUser);
                toastContainer?.ShowToast("User Saved Successfully", "success");
            }

            else if (ModalMode == "Edit")
            {
                if (!string.IsNullOrEmpty(Password))
                {
                    SelectedUser.PasswordHash = BCrypt.Net.BCrypt.HashPassword(Password);
                }
                await UserService.UpdateAsync(SelectedUser);
                toastContainer?.ShowToast("User Updated Successfully", "success");
            }


            Users = await UserService.GetAllAsync();
            CloseModal();

        }
        catch (Exception ex)
        {
            toastContainer?.ShowToast($"Error: {ex.Message}", "error");
            return;
        }

    }
}