@page "/Employees"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@using BCrypt.Net
@inject IEmployeeRepository EmployeeService
@inject IPositionRepository PositionService
@inject IRankRepository RankService

<div class="bg-white rounded-lg shadow-sm p-6">
    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
        <h2 class="text-2xl font-semibold text-gray-800">Employees Management</h2>
        <p class="text-gray-600 mt-1">Manage Employee , Add Employee and Edit Employee Data</p>
    </div>
</div>

<div class="p-6 space-y-6">

    <!-- Card Summary -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-6">
    <div class="bg-purple-800 text-white p-6 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Total Employees</h2>
        <p class="text-2xl font-bold">@TotalEmployees</p>
    </div>

    <div class="bg-green-400 text-white p-6 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">New Employee</h2>
        <p class="text-2xl font-bold">@NewEmployees</p>
    </div>

    <div class="bg-green-600 text-white p-6 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Active</h2>
            <p class="text-2xl font-bold">@Employees?.Count(u => u.IsActive)</p>
        </div>
        <div class="bg-red-600 text-white p-6 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Inactive</h2>
            <p class="text-2xl font-bold">@Employees?.Count(u => !u.IsActive)</p>
        </div>

    <div class="bg-yellow-500 text-white p-6 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Employee / Years</h2>
        <p class="text-2xl font-bold">@TotalYearsWorked</p>
    </div>

    <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Average Years</h2>
        <p class="text-2xl font-bold">@AverageYears.ToString("F1")</p> 
    </div>
</div>

    <!-- Search & Add -->
    <div class="flex justify-between items-center">
        <input type="text" placeholder="Search Employee..." @bind="SearchTerm"
            class="px-4 py-2 w-1/3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" />
        <button @onclick="AddEmployee" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition">
            + Add Employee
        </button>
    </div>

    <!-- Employee Table -->
    <div class="overflow-x-auto mt-4">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2">Employee name</th>
                    <th class="px-4 py-2">Rank</th>
                    <th class="px-4 py-2">Phone</th>
                    <th class="px-4 py-2">Email</th>
                    <th class="px-4 py-2">Position</th>
                    <th class="px-4 py-2">Active / InActive</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredEmployees != null)
                {
                    @foreach (var Employee in FilteredEmployees)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">@Employee.Name</td>
                            <td class="px-4 py-2">@Employee.Rank?.Name</td>
                            <td class="px-4 py-2">@Employee.Phone</td>
                            <td class="px-4 py-2">@Employee.Email</td>
                            <td class="px-4 py-2">@Employee.Position?.Name</td>
                            <td class="px-4 py-2">
                                <span class="@GetStatusClass(Employee.IsActive)">
                                    @(Employee.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-4 py-2">@Employee.Status</td>
                            <td class="px-4 py-2 whitespace-nowrap space-x-2">
                                <button class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm" @onclick="() => ShowDetail(Employee)">Detail</button>
                                <button class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm" @onclick="() => EditEmployee(Employee)">Edit</button>
                                <button class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm" @onclick="() => ConfirmDelete(Employee.Id, Employee.Name)">Delete</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Add/Edit/Detail -->
@if (ShowModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-3xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            @if (ModalMode == "Detail")
            {
                <!-- Detail View -->
                <div class="flex flex-col items-center mb-4">
                    @if (SelectedEmployee.PhotoData != null)
                    {
                        var base64 = Convert.ToBase64String(SelectedEmployee.PhotoData);
                        <img src="data:image/png;base64,@base64" class="w-40 h-40 rounded-full mb-4" />
                    }
                    else
                    {
                        <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-gray-500">No Photo</span>
                        </div>
                    }
                </div>

                <div class="grid grid-cols-2 gap-2 text-gray-700">
                    <div class="font-semibold">Employee Name</div>
                    <div>@SelectedEmployee.Name</div>

                    <div class="font-semibold">Gender</div>
                    <div>@SelectedEmployee.Gender</div>

                    <div class="font-semibold">Date of Birth</div>
                    <div>@SelectedEmployee.DateOfBirth.ToString("dddd, dd MMMM yyyy")</div>

                    <div class="font-semibold">Email</div>
                    <div>@SelectedEmployee.Email</div>

                    <div class="font-semibold">Phone</div>
                    <div>@SelectedEmployee.Phone</div>

                    <div class="font-semibold">Position</div>
                    <div>@SelectedEmployee.Position?.Name</div>

                    <div class="font-semibold">Active / InActive</div>
                    <div>
                    <span class="@GetStatusClass(SelectedEmployee.IsActive)">
                                    @(SelectedEmployee.IsActive ? "Active" : "Inactive")
                                </span>
                    </div>

                    <div class="font-semibold">Address</div>
                    <div>@SelectedEmployee.Address</div>

                    <div class="font-semibold">Status</div>
                    <div>@SelectedEmployee.Status</div>
                    

                    <div class="font-semibold">Rank</div>
                    <div>@SelectedEmployee.Rank.Name</div>

                    <div class="font-semibold">Join Date</div>
                    <div>@SelectedEmployee.JoinDate.ToString("dddd, dd MMMM yyyy")</div>

                    <div class="font-semibold">Period</div>
                    <div>@GetPeriod(SelectedEmployee.JoinDate)</div>
                </div>
            }
            else
            {
                <!-- Grid 2 kolom untuk form -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <input class="w-full px-3 py-2 border rounded" placeholder="Employee Name"
                               @bind="SelectedEmployee.Name" />

                        <input class="w-full px-3 py-2 border rounded" placeholder="NRP"
                               @bind="SelectedEmployee.NRP" />

                        <div class="font-semibold">Gender</div>
                        <select class="w-full px-3 py-2 border rounded"
                                @bind="SelectedEmployee.Gender">
                            <option value="">Select Gender</option>
                            <option value="Pria">Pria</option>
                            <option value="Wanita">Wanita</option>
                        </select>

                        <div class="font-semibold">Date of Birth</div>
                        <input class="w-full px-3 py-2 border rounded" type="date"
                               @bind="SelectedEmployee.DateOfBirth" />

                        <input class="w-full px-3 py-2 border rounded" placeholder="Email"
                               @bind="SelectedEmployee.Email" />

                        <input class="w-full px-3 py-2 border rounded" placeholder="Phone"
                               @bind="SelectedEmployee.Phone" />
                    </div>

                    <div class="space-y-2">
                        <div class="font-semibold">Position</div>
                        <select class="w-full px-3 py-2 border rounded"
                                @bind="SelectedEmployee.PositionId">
                            <option value="">Select Position</option>
                            @foreach (var pos in Positions)
                            {
                                <option value="@pos.Id">@pos.Name</option>
                            }
                        </select>

                        <div class="font-semibold">Status</div>
                        <select class="w-full px-3 py-2 border rounded"
                                @bind="SelectedEmployee.Status">
                            <option value="">Select Status</option>
                            <option value="Anggota Polri">Anggota Polri</option>
                            <option value="Tenaga Ahli">Tenaga Ahli</option>
                            <option value="Sipil">Sipil</option>
                        </select>

                        <div class="font-semibold">Rank</div>
                        <select class="w-full px-3 py-2 border rounded"
                                @bind="SelectedEmployee.RankId">
                            <option value="">Select Rank</option>
                            @foreach (var rank in Ranks)
                            {
                                <option value="@rank.Id">@rank.Name</option>
                            }
                        </select>

                        <input class="w-full px-3 py-2 border rounded" placeholder="Address"
                               @bind="SelectedEmployee.Address" />

                        <div class="font-semibold">Join Date</div>
                        <input class="w-full px-3 py-2 border rounded" type="date"
                               @bind="SelectedEmployee.JoinDate" />

                        <div class="font-semibold">Active</div>
                        <label class="flex items-center space-x-2 mb-2">
                            <input type="checkbox" @bind="SelectedEmployee.IsActive" />
                            <span>Active</span>
                        </label>

                        <div class="font-semibold">Photo</div>
                        <InputFile OnChange="OnFileChange" class="w-full" />
                    </div>
                </div>
            }


            <div class="flex justify-end space-x-2 mt-4">
                <button class="px-4 py-2 bg-red-600 text-white rounded" @onclick="CloseModal">Close</button>
                @if (ModalMode != "Detail")
                {
                    <button class="px-4 py-2 bg-blue-600 text-white rounded" @onclick="SaveEmployee">Save</button>
                }
            </div>
        </div>
    </div>
}


<!-- Modal Confirm Delete -->
@if (ShowConfirmModal)
{
    <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Delete</h3>
            <p class="text-gray-700 mb-6">@ConfirmMessage</p>
            <div class="flex justify-end space-x-3">
                <button class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg" @onclick="CancelDelete">Cancel</button>
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg" @onclick="DeleteConfirmed">Delete</button>
            </div>
        </div>
    </div>
}

<ToastContainer @ref="toastContainer" />

@code {

    Employee SelectedDateEmployee = new Employee
    {
        DateOfBirth = new DateOnly(2000, 1, 1),
        JoinDate = new DateOnly(2000, 1, 1)
    };
    private ToastContainer? toastContainer;

    private List<Employee> Employees = new();
    private List<Position> Positions = new();
    private List<Rank> Ranks = new();
    private string SearchTerm = "";
    private bool ShowModal = false;
    private string ModalTitle = "";
    private string ModalMode = "";
    private Employee SelectedEmployee = new();
    private string Password = "";

    private bool ShowConfirmModal = false;
    private string ConfirmMessage = "";
    private int EmployeeIdToDelete;

    protected override async Task OnInitializedAsync()
    {
        Employees = await EmployeeService.GetAllAsync();
        Positions = await PositionService.GetAllAsync();
        Ranks = await RankService.GetAllAsync();

    }

    private IEnumerable<Employee> FilteredEmployees => Employees
        .Where(u => string.IsNullOrWhiteSpace(SearchTerm) || u.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    private string GetStatusClass(bool active) =>
        active ? "px-2 py-1 text-xs bg-green-200 text-green-800 rounded-full" : "px-2 py-1 text-xs bg-red-200 text-red-800 rounded-full";

    private void ShowDetail(Employee Employee)
    {
        SelectedEmployee = Employee;
        ModalTitle = "Employee Detail";
        ModalMode = "Detail";
        ShowModal = true;
    }

    private void AddEmployee()
    {
        SelectedEmployee = new Employee
        {
            DateOfBirth = new DateOnly(2000, 1, 1),
            JoinDate = new DateOnly(2000, 1, 1)
        };
        ModalTitle = "Add Employee";
        ModalMode = "Add";
        ShowModal = true;
    }

     private int TotalEmployees => Employees?.Count() ?? 0;

    private int NewEmployees => Employees?.Count(u => u.JoinDate >= DateOnly.FromDateTime(DateTime.Now.AddYears(-1))) ?? 0;

    private int TotalYearsWorked => Employees?.Sum(u => 
        {
            var join = u.JoinDate.ToDateTime(TimeOnly.MinValue);
            var now = DateTime.Now;
            int years = now.Year - join.Year;
            if (now.Month < join.Month || (now.Month == join.Month && now.Day < join.Day))
                years--;
            return years;
        }) ?? 0;

    private double AverageYears => TotalEmployees > 0 ? (double)TotalYearsWorked / TotalEmployees : 0;


    private void EditEmployee(Employee Employee)
    {
        SelectedEmployee = Employee;
        ModalTitle = "Edit Employee";
        ModalMode = "Edit";
        ShowModal = true;
    }

    private void CloseModal() => ShowModal = false;

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream(10_000_000).ReadAsync(buffer);
        SelectedEmployee.PhotoData = buffer;
    }

    private void ConfirmDelete(int id, string name)
    {
        EmployeeIdToDelete = id;
        ConfirmMessage = $"Are you sure you want to delete Employee \"{name}\"?";
        ShowConfirmModal = true;
    }

    private void CancelDelete() => ShowConfirmModal = false;

    private async Task DeleteConfirmed()
    {
        await EmployeeService.DeleteAsync(EmployeeIdToDelete);
        Employees = await EmployeeService.GetAllAsync();
        ShowConfirmModal = false;
        toastContainer?.ShowToast("Employee berhasil dihapus!", "success");
    }

    private string GetPeriod(DateOnly joinDate)
    {
        var start = joinDate.ToDateTime(TimeOnly.MinValue);
        var end = DateTime.Now;

        int years = end.Year - start.Year;
        int months = end.Month - start.Month;
        int days = end.Day - start.Day;

        // Jika hari negatif, pinjam 1 bulan
        if (days < 0)
        {
            months--;
            days += DateTime.DaysInMonth(start.Year, start.Month);
        }

        // Jika bulan negatif, pinjam 1 tahun
        if (months < 0)
        {
            years--;
            months += 12;
        }

        return $"{years} tahun {months} bulan {days} hari";
    }

    

    private async Task SaveEmployee()
    {
        try
        {

            if (ModalMode == "Add")
            {
                await EmployeeService.AddAsync(SelectedEmployee);
                toastContainer?.ShowToast("Employee berhasil ditambahkan!", "success");
            }
            else if (ModalMode == "Edit")
            {
                await EmployeeService.UpdateAsync(SelectedEmployee);
                toastContainer?.ShowToast("Employee berhasil diperbarui!", "success");
            }

            Employees = await EmployeeService.GetAllAsync();
            CloseModal();
        }
        catch (Exception ex)
        {
            toastContainer?.ShowToast($"Error: {ex.Message}", "error");
        }
    }
}
