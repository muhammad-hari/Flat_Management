@page "/data-care/restore-data"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IDataCareService BackupService
@inject ToastService ToastService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject IPermissionService PermissionService

<PageTitle>Restore Data</PageTitle>

<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
            <div>
                <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight flex items-center gap-3">
                    <i class="fas fa-undo text-orange-600"></i>
                    Restore Data Management
                </h2>
                <p class="text-gray-500 mt-1">Restore database from backup files and view restore history</p>
            </div>
            @if (CanCreate || CanUpdate)
            {
                <button @onclick="OpenRestoreModal"
                        class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fas fa-upload"></i>
                    <span>Restore from File</span>
                </button>
            }
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm font-medium">Total Restore</p>
                    <h3 class="text-3xl font-bold mt-2">@RestoreHistories.Count</h3>
                </div>
                <div class="bg-white/20 p-4 rounded-lg">
                    <i class="fas fa-undo fa-2x"></i>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm font-medium">Success</p>
                    <h3 class="text-3xl font-bold mt-2">@RestoreHistories.Count(r => r.Status == "Success")</h3>
                </div>
                <div class="bg-white/20 p-4 rounded-lg">
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-red-100 text-sm font-medium">Failed</p>
                    <h3 class="text-3xl font-bold mt-2">@RestoreHistories.Count(r => r.Status == "Failed")</h3>
                </div>
                <div class="bg-white/20 p-4 rounded-lg">
                    <i class="fas fa-times-circle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore History Table -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mt-6">
        <div class="p-6">
            <div class="space-y-4">
                @if (!RestoreHistories.Any())
                {
                    <div class="text-center py-12">
                        <i class="fas fa-history fa-4x text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No restore history available.</p>
                    </div>
                }
                else
                {
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">File Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Restored By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Error</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                @foreach (var history in RestoreHistories)
                                {
                                    <tr>
                                        <td class="px-6 py-4">@history.FileName</td>
                                        <td class="px-6 py-4">@history.UserName</td>
                                        <td class="px-6 py-4">
                                            <span class="@GetStatusBadgeClass(history.Status) px-2 py-1 rounded text-xs font-semibold">
                                                @history.Status
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            @(history.CompletedAt.HasValue? FormatDateTime(history.CompletedAt.Value) : "")
                                        </td>
                                        <td class="px-6 py-4">@history.DurationSeconds s</td>
                                        <td class="px-6 py-4 text-xs text-red-600">@history.ErrorMessage</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Restore from File -->
@if (ShowRestoreModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @onclick="CloseRestoreModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full" @onclick:stopPropagation>
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-upload text-orange-600 mr-2"></i>
                    Restore Database from Backup File
                </h3>
                <button @onclick="CloseRestoreModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="p-6">
                <InputFile OnChange="OnRestoreFileSelected" />
                @if (!string.IsNullOrEmpty(RestoreFileName))
                {
                    <div class="mt-3 text-sm text-gray-700">
                        Selected: <b>@RestoreFileName</b>
                    </div>
                }
                <div class="mt-6 flex justify-end gap-3">
                    <button @onclick="CloseRestoreModal"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-6 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button @onclick="RestoreFromUpload"
                            disabled="@(IsRestoring)"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-semibold px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        @if (IsRestoring)
                        {
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                        }
                        else
                        {
                            <i class="fas fa-upload mr-2"></i>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<RestoreHistory> RestoreHistories = new();
    private bool ShowRestoreModal = false;
    private bool IsRestoring = false;
    private string RestoreFileName = string.Empty;
    private IBrowserFile? RestoreFile;
    private bool CanView = false;
    private bool CanUpdate = false;
    private bool CanCreate = false;
    private bool CanDelete = false;
    private int? CurrentUserId;

    protected override async Task OnInitializedAsync()
    {
        CanView = await PermissionService.HasPermissionAsync("restore-data", "view");
        CanCreate = await PermissionService.HasPermissionAsync("restore-data", "create");
        CanUpdate = await PermissionService.HasPermissionAsync("restore-data", "update");
        CanDelete = await PermissionService.HasPermissionAsync("restore-data", "delete");

        if (!CanView)
        {
            NavigationManager.NavigateTo("/unauthorized");
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            CurrentUserId = userId;

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            RestoreHistories = await BackupService.GetRestoreHistoryAsync(1, 50);
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error loading data: {ex.Message}");
        }
    }

    private void OpenRestoreModal()
    {
        RestoreFileName = string.Empty;
        ShowRestoreModal = true;
    }

    private void CloseRestoreModal()
    {
        ShowRestoreModal = false;
        RestoreFileName = string.Empty;
    }

    private async Task OnRestoreFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.GetMultipleFiles(1).FirstOrDefault();
        if (file != null)
        {
            RestoreFile = e.File;
            RestoreFileName = file.Name;
        }
    }

    private async Task RestoreFromUpload()
    {
        if (RestoreFile == null)
        {
            await ToastService.ShowWarning("Please select a backup file first.");
            return;
        }

        IsRestoring = true;
        StateHasChanged();

        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Restore database from file '{RestoreFile.Name}'?\nThis will overwrite ALL current data. Continue?");
            if (!confirmed)
            {
                IsRestoring = false;
                return;
            }

            // Upload file ke server (endpoint API Anda harus menyimpan file lalu panggil RestoreBackupFromFileAsync)
            var content = new MultipartFormDataContent();
            var stream = RestoreFile.OpenReadStream(1024 * 1024 * 100); // max 100MB
            content.Add(new StreamContent(stream), "file", RestoreFile.Name);

            var response = await Http.PostAsync("api/datacare/restore/upload", content);

            if (response.IsSuccessStatusCode)
            {
                await ToastService.ShowSuccess("✅ Database restored successfully! Page will reload...");
                CloseRestoreModal();
                await Task.Delay(2000);
                NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await ToastService.ShowError($"❌ Restore failed: {error}");
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"❌ Restore failed: {ex.Message}");
        }
        finally
        {
            IsRestoring = false;
            StateHasChanged();
        }
    }

    private string FormatDateTime(DateTime dateTime) => dateTime.ToString("dd MMM yyyy HH:mm");

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Success" => "bg-green-100 text-green-800",
        "Failed" => "bg-red-100 text-red-800",
        "Pending" => "bg-yellow-100 text-yellow-800",
        _ => "bg-gray-100 text-gray-800"
    };
}