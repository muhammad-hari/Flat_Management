@page "/rooms"
@using Microsoft.AspNetCore.Components.Forms
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IRoomRepository RoomService
@inject IRoomStatusRepository RoomStatusService
@inject IRoomCategoryRepository RoomCategoryService
@inject IRoomConditionRepository RoomConditionService
@inject IBuildingRepository BuildingService
@inject IFileService FileService
@inject Blazored.Toast.Services.IToastService ToastService

<div class="bg-white rounded-lg shadow-sm p-6">

    <!-- HEADER -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-semibold text-gray-800">Room Management</h2>
            <p class="text-gray-600 mt-1">Manage Room Category, Status & Condition</p>
        </div>
        <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" @onclick="AddRoom">
            + Add Room
        </button>
    </div>

    <!-- ROOM GRID -->
    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(14rem,1fr));">
        @foreach (var r in FilteredRooms)
        {
            <div class="relative bg-gradient-to-b from-red-200 to-black rounded-lg shadow p-3 flex flex-col">
                <span class="absolute top-2 right-2 bg-red-700 text-white text-xs font-bold px-2 py-1 rounded-full">
                    @r.Floor F
                </span>

                @if (FilesByRoom.TryGetValue(r.Id, out var files) && files.Any())
                {
                    <img src="@($"/secure-files/{files.First().Path}")"
                        class="w-full h-40 object-cover rounded mb-2 cursor-pointer hover:scale-105 transition-transform"
                        @onclick="@(() => ShowPreview(files.First().Path))" />
                }
                else
                {
                    <div class="w-full h-40 bg-gray-200 rounded flex items-center justify-center text-gray-500">
                        No Image
                    </div>
                }

                <h3 class="text-md font-semibold text-white truncate">@r.Name (@r.RoomNo)</h3>
                <p class="text-gray-300 text-sm">@r.Category?.Name</p>
                <p class="text-gray-400 text-xs">@r.Status?.Name</p>

                <div class="mt-3 flex justify-end gap-2">
                    <button class="px-2 py-1 bg-blue-500 text-white rounded" @onclick="@(() => EditRoom(r))">Edit</button>
                    <button class="px-2 py-1 bg-red-500 text-white rounded"
                        @onclick="@(() => ConfirmDelete(r.Id, r.Name))">Delete</button>
                </div>
            </div>
        }
    </div>

    <!-- MODAL ADD/EDIT -->
    @if (ShowModal)
    {
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-xl">
                <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

                <EditForm Model="@Selected" OnValidSubmit="SaveRoom">
                    <DataAnnotationsValidator />

                    <div class="grid gap-2">
                        <InputText class="border rounded px-3 py-2" @bind-Value="Selected.Name" placeholder="Room Name" />
                        <InputText class="border rounded px-3 py-2" @bind-Value="Selected.RoomNo" placeholder="Room No" />

                        <!-- Building Dropdown -->
                        <label>Building
                            <select class="border rounded px-3 py-2" @bind="Selected.BuildingId"
                                @bind:after="OnBuildingChanged">
                                <option value="0">-- Select Building --</option>
                                @foreach (var b in Buildings)
                                {
                                    <option value="@b.Id">@b.Name</option>
                                }
                            </select>
                        </label>

                        <!-- Floor Dropdown (auto 1..TotalFloors) -->
                        <label>Floor
                            <select class="border rounded px-3 py-2" @bind="Selected.Floor">
                                <option value="0">-- Select Floor --</option>
                                @foreach (var f in FloorOptions)
                                {
                                    <option value="@f">@f</option>
                                }
                            </select>
                        </label>

                        <InputNumber TValue="int" @bind-Value="Selected.Size" class="border rounded px-3 py-2"
                            placeholder="Size (mÂ²)" />

                        <label>Category
                            <select class="border rounded px-3 py-2" @bind="Selected.CategoryId">
                                <option value="0">-- Select --</option>
                                @foreach (var c in Categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                        </label>

                        <label>Status
                            <select class="border rounded px-3 py-2" @bind="Selected.StatusId">
                                <option value="0">-- Select --</option>
                                @foreach (var s in Statuses)
                                {
                                    <option value="@s.Id">@s.Name</option>
                                }
                            </select>
                        </label>

                        <label>Condition
                            <select class="border rounded px-3 py-2" @bind="Selected.ConditionId">
                                <option value="0">-- Select --</option>
                                @foreach (var c in Conditions)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            </select>
                        </label>

                        <label class="block mt-2">
                            Upload Image
                            <InputFile OnChange="HandleFileSelected" />
                        </label>


                        <label class="flex items-center gap-2">
                            <InputCheckbox @bind-Value="Selected.IsAvailable" /> Available
                        </label>
                    </div>

                    <div class="mt-4 flex justify-end gap-2">
                        <button type="button" class="bg-gray-300 px-4 py-2 rounded" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

<ToastContainer @ref="toastContainer" />

@code {
    private ToastContainer? toastContainer;
    private List<Room> Rooms = new();
    private List<Building> Buildings = new(); // <--- Tambahan
    private List<int> FloorOptions = new(); // <--- Tambahan
    private List<RoomCategory> Categories = new();
    private List<RoomStatus> Statuses = new();
    private List<RoomCondition> Conditions = new();
    private string? PreviewPath;
    private void ShowPreview(string path) => PreviewPath = path;

    private Dictionary<int, List<FileUpload>> FilesByRoom = new();
    private bool ShowModal;
    private string ModalTitle = "";
    private Room Selected = new();
    private bool ShowConfirmModal = false;
    private int RoomIdToDelete;
    private MarkupString ConfirmMessage;
    private IBrowserFile? uploadedFile;

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        Buildings = (await BuildingService.GetAllAsync())?.ToList() ?? new();
    }



    private async Task LoadData()
    {
        Rooms = (await RoomService.GetAllAsync())?.ToList() ?? new();
        Categories = (await RoomCategoryService.GetAllAsync())?.ToList() ?? new();
        Statuses = (await RoomStatusService.GetAllAsync())?.ToList() ?? new();
        Conditions = (await RoomConditionService.GetAllAsync())?.ToList() ?? new();
    }

    private void AddRoom()
    {
        Selected = new Room { IsAvailable = true };
        FloorOptions.Clear();
        ModalTitle = "Add Room";
        ShowModal = true;
    }

    private void EditRoom(Room r)
    {
        Selected = new Room
        {
            Id = r.Id,
            Name = r.Name,
            RoomNo = r.RoomNo,
            Floor = r.Floor,
            Size = r.Size,
            BuildingId = r.BuildingId,
            CategoryId = r.CategoryId,
            StatusId = r.StatusId,
            ConditionId = r.ConditionId,
            IsAvailable = r.IsAvailable
        };

        // Generate floors for current building
        var b = Buildings.FirstOrDefault(x => x.Id == r.BuildingId);
        FloorOptions = b is null ? new() : Enumerable.Range(1, b.TotalFloors).ToList();

        ModalTitle = "Edit Room";
        ShowModal = true;
    }

    private void OnBuildingChanged()
    {
        var b = Buildings.FirstOrDefault(x => x.Id == Selected.BuildingId);
        FloorOptions = b is null ? new() : Enumerable.Range(1, b.TotalFloors).ToList();
        Selected.Floor = 0;
    }

    private async Task SaveRoom()
    {
        if (Selected.Id == 0)
            await RoomService.AddAsync(Selected);
        else
            await RoomService.UpdateAsync(Selected);

        // Upload file jika ada
        if (uploadedFile != null)
        {
            using var stream = uploadedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // contoh 10 MB
            await FileService.SaveFileAsync(uploadedFile, "Rooms", Selected.Id);
            uploadedFile = null;
        }

        @* if (uploadedFile != null)
            foreach (var f in uploadedFile)
                await FileService.SaveFileAsync(f, "Building", Selected.Id); *@

        ShowModal = false;
        await LoadData();
    }

    private void CloseModal() => ShowModal = false;

    private void CancelDelete()
    {
        ShowConfirmModal = false;
    }
    private void ConfirmDelete(int id, string name)
    {
        RoomIdToDelete = id;
        ConfirmMessage = new MarkupString(
        $"Are you sure you want to delete the Building <b>\"{name}\"</b> ?"
        );
        ShowConfirmModal = true;
    }

    private IEnumerable<Room> FilteredRooms => Rooms; // filter bisa ditambah
}