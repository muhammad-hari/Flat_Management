@page "/rooms"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IRoomRepository RoomService
@inject IRoomStatusRepository RoomStatusService
@inject IRoomCategoryRepository RoomCategoryService
@inject IRoomConditionRepository RoomConditionService
@inject Blazored.Toast.Services.IToastService ToastService


<div class="bg-white rounded-lg shadow-sm p-6">
    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
        <h2 class="text-2xl font-semibold text-gray-800">Room Category Management</h2>
        <p class="text-gray-600 mt-1">Manage User Room Condition,Category and Status</p>
    </div>
</div>
<div class="p-4 space-y-4">
    <!-- Card Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-purple-800 text-white p-4 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Total Rooms</h2>
        <p class="text-2xl font-bold">@Rooms.Count</p>
    </div>

    <div class="bg-green-600 text-white p-4 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Available Rooms</h2>
        <p class="text-2xl font-bold">@Rooms.Count(r => r.IsAvailable)</p>
    </div>

    <div class="bg-yellow-600 text-white p-4 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Reserved Rooms</h2>
        <p class="text-2xl font-bold">@Rooms.Count(r => r.Status?.Name == "Reserved")</p>
    </div>

    <div class="bg-red-600 text-white p-4 rounded-2xl shadow-md">
        <h2 class="text-lg font-semibold">Maintenance Rooms</h2>
        <p class="text-2xl font-bold">@Rooms.Count(r => r.Status?.Name == "Maintenance")</p>
    </div>
</div>

</div>


<div class="p-6 space-y-6">
    <!-- Search & Add -->
    <div class="flex justify-between items-center mb-4">
        <input type="text" placeholder="Search Room..." @bind="SearchTerm"
               class="px-4 py-2 w-1/3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" />
        <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition" @onclick="AddRoom">
            + Add Room
        </button>
    </div>

    <!-- Card Grid -->
    @if (FilteredRooms.Any())
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            @foreach (var room in PagedRooms)
            {
                <div class="bg-white rounded-2xl shadow-lg p-4 flex flex-col gap-1">
                    @if (room.PhotoData != null)
                    {
                        var base64 = Convert.ToBase64String(room.PhotoData);
                        <img src="data:image/png;base64,@base64"   class="w-full aspect-[4/3] object-cover rounded-lg mb-2" />
                    }
                    else
                    {
                        <div class="w-full h-32 bg-gray-200 flex items-center justify-center rounded-lg mb-2">
                            <span class="text-gray-400 text-sm">No Photo</span>
                        </div>
                    }

                    <h3 class="text-lg font-semibold mb-1">@room.Name (@room.RoomNo)</h3>
                    <p class="text-sm text-gray-600">@room.Category?.Name</p>
                    <p class="text-sm text-gray-600">@room.Status?.Name</p>
                    <p class="text-sm text-gray-600">Floor: @room.Floor | Capacity: @room.Size </p>
                    <p class="text-sm">
                        <span class="@GetAvailabilityClass(room.IsAvailable)">
                            @(room.IsAvailable ? "Available" : "Not Available")
                        </span>
                    </p>

                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm" @onclick="() => EditRoom(room)">Edit</button>
                        <button class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm"  @onclick="() => ConfirmDelete(room.Id,room.Name)">Delete</button>

                    </div>
                </div>
            }

        </div>
    }
    else
    {
        <div class="flex justify-center items-center mt-16 flex-col text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 018 0v2m-4-4v4m0-4V5m0 0V5a4 4 0 10-8 0v2" />
            </svg>
            <div>No Data</div>
        </div>
    }
</div>
<!-- Pagination -->
@if (TotalPages > 1)
{
    <div class="flex justify-center mt-4 space-x-2">
        <button class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
                @onclick="() => ChangePage(CurrentPage - 1)" disabled="@(CurrentPage == 1)">Prev</button>

        @for (int i = 1; i <= TotalPages; i++)
        {
            <button class="px-3 py-1 rounded @(CurrentPage == i ? "bg-blue-600 text-white" : "bg-gray-200 hover:bg-gray-300")"
                    @onclick="() => ChangePage(i)">@i</button>
        }

        <button class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
                @onclick="() => ChangePage(CurrentPage + 1)" disabled="@(CurrentPage == TotalPages)">Next</button>
    </div>
}

<!-- Modal Add/Edit Room -->
@if (ShowModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-3xl shadow-lg">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            <EditForm Model="SelectedRoom" OnValidSubmit="SaveRoom">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <input class="w-full px-3 py-2 border rounded" placeholder="Room Name"
                               @bind="SelectedRoom.Name" />
                        <input class="w-full px-3 py-2 border rounded" placeholder="Room No"
                               @bind="SelectedRoom.RoomNo" />
                        <div class="font-semibold">Category</div>
                        <select class="w-full px-3 py-2 border rounded" @bind="SelectedRoom.CategoryId">
                            <option value="0">Select Category</option>
                            @foreach (var c in Categories)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                        <div class="font-semibold">Status</div>
                        <select class="w-full px-3 py-2 border rounded" @bind="SelectedRoom.StatusId">
                            <option value="0">Select Status</option>
                            @foreach (var s in Statuses)
                            {
                                <option value="@s.Id">@s.Name</option>
                            }
                        </select>
                        <div class="font-semibold">Condition</div>
                        <select class="w-full px-3 py-2 border rounded" @bind="SelectedRoom.ConditionId">
                            <option value="0">Select Condition</option>
                            @foreach (var c in Conditions)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                        <div class="font-semibold">Floor</div>
                        <InputNumber @bind-Value="SelectedRoom.Floor" class="w-full px-3 py-2 border rounded" />
                        <div class="font-semibold">Size</div>
                        <InputNumber @bind-Value="SelectedRoom.Size" class="w-full px-3 py-2 border rounded" />
                        <div class="font-semibold">Available</div>
                        <InputCheckbox @bind-Value="SelectedRoom.IsAvailable" />
                    </div>

                    <div class="space-y-2">
                        <div class="font-semibold">Photo</div>
                        <InputFile OnChange="OnPhotoChange" accept="image/*" />

                        <div class="font-semibold">Document</div>
                        <InputFile OnChange="OnDocumentChange" accept=".pdf,.doc,.docx" />
                    </div>
                </div>

                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded" @onclick="CloseModal">Close</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (ShowConfirmModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg">
            <h2 class="text-lg font-bold mb-4">Confirm Delete</h2>
            <p class="mb-6">@ConfirmMessage</p>
            <div class="flex justify-end space-x-2">
                <button class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" @onclick="CancelDelete">Cancel</button>
                <button class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700" @onclick="DeleteConfirmed">Delete</button>
            </div>
        </div>
    </div>
}


<ToastContainer @ref="toastContainer" />

@code {
    private ToastContainer? toastContainer;
    private int CurrentPage = 1;
    private int PageSize = 5; 
    private int TotalPages => (int)Math.Ceiling((double)FilteredRooms.Count() / PageSize);

    private List<Room> Rooms = new();
    private List<RoomCategory> Categories = new();
    private List<RoomStatus> Statuses = new();
    private List<RoomCondition> Conditions = new(); // <- baru
    private string SearchTerm = "";
    private bool ShowModal = false;
    private string ModalTitle = "";
    private Room SelectedRoom = new();

    private bool ShowConfirmModal = false;
    private string ConfirmMessage = "";
    private int RoomIdToDelete;

    private IEnumerable<Room> PagedRooms => FilteredRooms
    .Skip((CurrentPage - 1) * PageSize)
    .Take(PageSize);


    protected override async Task OnInitializedAsync()
    {
        Rooms = await RoomService.GetAllAsync();
        Categories = await RoomCategoryService.GetAllAsync();
        Statuses = await RoomStatusService.GetAllAsync();
        Conditions = await RoomConditionService.GetAllAsync(); // <- baru
    }

    private void ChangePage(int page)
    {
        if (page < 1) page = 1;
        if (page > TotalPages) page = TotalPages;
        CurrentPage = page;
    }


    private IEnumerable<Room> FilteredRooms => Rooms
        .Where(r => string.IsNullOrWhiteSpace(SearchTerm) || r.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    private string GetAvailabilityClass(bool available) =>
        available ? "px-2 py-1 text-xs bg-green-200 text-green-800 rounded-full" : "px-2 py-1 text-xs bg-red-200 text-red-800 rounded-full";

    private void AddRoom()
    {
        SelectedRoom = new Room();
        ModalTitle = "Add Room";
        ShowModal = true;
    }

    private void EditRoom(Room room)
    {
        SelectedRoom = room;
        ModalTitle = "Edit Room";
        ShowModal = true;
    }

    private void CloseModal() => ShowModal = false;

    private async Task SaveRoom()
    {
        try
        {
            if (SelectedRoom.CategoryId == 0 || SelectedRoom.StatusId == 0 || SelectedRoom.ConditionId == 0)
            {
                toastContainer?.ShowToast("Category, Status, and Condition are required.",type:"warning");
                return;
            }


            if (SelectedRoom.Id == 0)
            {
                await RoomService.AddAsync(SelectedRoom);
                toastContainer?.ShowToast("Room added successfully!",type:"success");
            }
            else
            {
                await RoomService.UpdateAsync(SelectedRoom);
                toastContainer?.ShowToast("Room updated successfully!",type:"success");
            }

            Rooms = await RoomService.GetAllAsync();
            CloseModal();
        }
        catch (Exception ex)
        {
            toastContainer?.ShowToast($"Error: {ex.Message}",type:"error");
        }
    }

    private async Task OnPhotoChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (!file.ContentType.StartsWith("image/"))
        {
            toastContainer?.ShowToast("Only image files are allowed!",type:"warning");
            return;
        }

        var buffer = new byte[file.Size];
        await file.OpenReadStream(5_000_000).ReadAsync(buffer); // max 5 MB
        SelectedRoom.PhotoData = buffer;
    }

    private async Task OnDocumentChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (!new[] { "application/pdf", 
                     "application/msword", 
                     "application/vnd.openxmlformats-officedocument.wordprocessingml.document" }
                     .Contains(file.ContentType))
        {
            ToastService.ShowWarning("Only PDF/DOC/DOCX files are allowed!");
            return;
        }

        var buffer = new byte[file.Size];
        await file.OpenReadStream(10_000_000).ReadAsync(buffer); // max 10 MB
        SelectedRoom.DocumentData = buffer;
        SelectedRoom.DocumentContentType = file.ContentType;
        SelectedRoom.DocumentName = file.Name;
    }

    private void ConfirmDelete(int id, string name)
    {
        RoomIdToDelete = id;
        ConfirmMessage = $"Are you sure you want to delete room \"{name}\"?";
        ShowConfirmModal = true;
    }

    private void CancelDelete() => ShowConfirmModal = false;

    private async Task DeleteConfirmed()
    {
        await RoomService.DeleteAsync(RoomIdToDelete);
        Rooms = await RoomService.GetAllAsync();
        ShowConfirmModal = false;
        toastContainer?.ShowToast("Room deleted successfully!",type:"success");
    }
}
