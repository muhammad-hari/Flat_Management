@page "/occupants"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IOccupantRepository OccupantService
@inject IEmployeeRepository EmployeeService
@inject IRoomRepository RoomService
@inject IFileService FileService
@inject IOccupantHistoryRepository HistoryService


<div class="bg-gradient-to-b from-red-700 to-black rounded-lg shadow-sm p-6">
    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
        <h2 class="text-2xl font-semibold text-gray-800">
            Occupant Records Management
        </h2>
        <p class="text-gray-600 mt-1">
            Efficiently manage and track occupant check-in, check-out, and transfer operations.
        </p>
    </div>
</div>

<div class="p-6 space-y-6">
    <!-- Summary Card -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-blue-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Occupants</h2>
            <p class="text-2xl font-bold">@Occupants?.Count()</p>
        </div>
        <div class="bg-green-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Active</h2>
            <p class="text-2xl font-bold">@Occupants?.Count(u => u.DepartedAt == null)</p>
        </div>
        <div class="bg-red-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Inactive</h2>
            <p class="text-2xl font-bold">@Occupants?.Count(u => u.DepartedAt != null)</p>
        </div>
        <div class="bg-purple-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Transfer</h2>
            <p class="text-2xl font-bold">2</p>
        </div>
    </div>
</div>

<div class="p-6 space-y-6">
    <div class="flex justify-between items-center">
        <input type="text" placeholder="Search Occupant,NRP,Position,Rank,Building,Room..." @bind="SearchTerm"
               class="px-4 py-2 w-1/3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" />
        <button @onclick="()=>ShowAddModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-blue-800">
            + Add Occupant
        </button>
    </div>

    <!-- Table Occupants -->
    <div class="overflow-x-auto mt-4">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
            <thead class="bg-gradient-to-b from-red-700 to-black">
                <tr>
                    <th class="px-4 py-2 text-white">Employee name</th>
                    <th class="px-4 py-2 text-white">NRP</th>
                    <th class="px-4 py-2 text-white">Phone</th>
                    <th class="px-4 py-2 text-white">Position</th>
                    <th class="px-4 py-2 text-white">Rank</th>
                    <th class="px-4 py-2 text-white">Arrived Date</th>
                    <th class="px-4 py-2 text-white">Departed Date</th>
                    <th class="px-4 py-2 text-white">Building</th>
                    <th class="px-4 py-2 text-white">Floor</th>
                    <th class="px-4 py-2 text-white">Room</th>
                    <th class="px-4 py-2 text-white">Status</th>
                    <th class="px-4 py-2 text-white">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredOccupants != null && FilteredOccupants.Any())
                {
                    @foreach (var occupant in FilteredOccupants)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">@occupant.Employee?.Name</td>
                            <td class="px-4 py-2">@occupant.Employee?.NRP</td>
                            <td class="px-4 py-2">@occupant.Employee?.Phone</td>
                            <td class="px-4 py-2">@occupant.Employee?.Position?.Name</td>
                            <td class="px-4 py-2">@occupant.Employee?.Rank?.Name</td>
                            <td class="px-4 py-2">@occupant.ArrivedAt.ToString("dd MMM yyyy")</td>
                            <td class="px-4 py-2">@occupant.DepartedAt?.ToString("dd MMM yyyy")</td>
                            <td class="px-4 py-2">@occupant.Room?.Building.Name</td>
                            <td class="px-4 py-2">@occupant.Room?.Floor</td>
                            <td class="px-4 py-2">@occupant.Room?.Name</td>
                            <td class="px-4 py-2">
                                <span class="@GetStatusClass(occupant.DepartedAt == null)">
                                    @(occupant.DepartedAt == null ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-4 py-2 space-x-2">
                                <button class="px-2 py-1 bg-blue-500 text-white rounded" @onclick="async () => await ShowDetail(occupant)">Detail</button>
                                <button class=@($"px-2 py-1 text-white rounded {(occupant.DepartedAt == null ? "bg-red-500 hover:bg-red-600" : "bg-gray-400 cursor-not-allowed")}")
                                        @onclick="()=>ShowCheckoutModal(occupant.Id)"
                                        disabled="@(occupant.DepartedAt != null)">
                                    Checkout
                                </button>
                                <button class=@($"px-2 py-1 text-white rounded {(occupant.DepartedAt == null ? "bg-yellow-500 hover:bg-yellow-600" : "bg-gray-400 cursor-not-allowed")}")
                                        @onclick="()=>ShowTransferModal(occupant.Id)"
                                        disabled="@(occupant.DepartedAt != null)">
                                    Transfer
                                </button>

                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="9" class="py-12 text-center text-gray-400">No Data</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

@* Modal Add/Edit Occupant *@
@if (ShowModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md overflow-y-auto max-h-screen">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            @if (AddStep == 1)
            {
                <div>
                    <label class="block mb-1">Enter NRP</label>
                    <div class="flex items-center gap-2">
                        <input class="flex-1 px-3 py-2 border rounded mt-1 disabled:bg-gray-100"
                            placeholder="NRP"
                            @bind="NRPInput"
                            @onkeyup="OnNRPEnter"
                            disabled="@isLoading" />

                        @if (isLoading)
                        {
                            <!-- Spinner -->
                            <div class="animate-spin border-2 border-t-transparent border-blue-500 rounded-full w-5 h-5"></div>
                        }
                        else
                        {
                            <button class="px-2" @onclick="SearchNRP">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        }
                    </div>
                </div>
            }

            else if (AddStep == 2)
            {
                <div class="flex flex-col items-center mb-4">
                    @* Photo *@
                    @if (PhotoByEmployee.TryGetValue(SelectedOccupant.EmployeeId, out var photos) && photos.Any())
                    {
                        <img src="@($"/secure-files/{photos.First().Path}")"
                            class="w-40 h-40 rounded-full mx-auto mb-4 object-cover" />
                    }
                    else
                    {
                        <div class="w-40 h-40 rounded-full bg-gray-200 mx-auto mb-4 flex items-center justify-center text-gray-500">
                            No Photo
                        </div>
                    }
                </div>
                <div class="space-y-2">
                    <div><b>NRP: @SelectedOccupant.Employee?.NRP</b</div>
                    <div>Name: @SelectedOccupant.Employee?.Name</div>
                    <div>Gender: @SelectedOccupant.Employee?.Gender</div>
                    <div>Phone: @SelectedOccupant.Employee?.Phone</div>
                    <div>Position: @SelectedOccupant.Employee?.Position?.Name</div>
                    <div>Rank: @SelectedOccupant.Employee?.Rank?.Name</div>
                </div>
            }
            else if (AddStep == 3)
            {
                <div class="space-y-2">
                    <label>Select Room</label>
                    <select class="w-full border rounded px-2 py-1" @bind="SelectedOccupant.RoomId">
                        <option value="">Select Room</option>
                        @foreach(var room in Rooms)
                        {
                            <option value="@room.Id">@room.RoomNo</option>
                        }
                    </select>

                    @* <label>Upload Photo</label>
                    <InputFile OnChange="OnPhotoSelected" accept="image/*" />

                    <label>Upload Document</label>
                    <InputFile OnChange="OnDocumentSelected" accept=".pdf,.doc,.docx" /> *@
                </div>
                <div class="mb-4">
                    <label class="block font-semibold mb-1">Photo</label>
                    <InputFile OnChange="OnPhotoSelected" accept="image/*" />
                    <p class="text-xs text-gray-500 text-red-500">Max 2 MB,Image *.jpg,.jpeg,.png </p>
                </div>

                <!-- Upload Dokumen PDF -->
                <div class="mb-4">
                    <label class="block font-semibold mb-1">Documents (.PDF) (Optional)</label>
                    <InputFile OnChange="OnDocsSelected" multiple accept="application/pdf" />
                    <p class="text-xs text-gray-500 text-red-500">Max 10 MB ,PDF Only</p>
                </div>
            }

            <div class="flex justify-end space-x-2 mt-4">
                @if(AddStep > 1)
                {
                    <button class="px-3 py-1 bg-gray-300 rounded" @onclick="()=>AddStep--">Back</button>
                }
                @if(AddStep == 2)
                {
                    <button class="px-3 py-1 bg-blue-600 text-white rounded" @onclick="NextStep">Next</button>
                }
                @if(AddStep == 3)
                {
                    <button class="px-3 py-1 bg-green-600 text-white rounded" @onclick="SaveOccupant">Save</button>
                }
                <button class="px-3 py-1 bg-red-500 text-white rounded" @onclick="()=>ShowModal=false">Close</button>
            </div>
        </div>
    </div>
}

@* Modal Detail Occupant *@
@if (ShowDetailModal && SelectedOccupant != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
            <div class="absolute inset-0 flex justify-center items-center pointer-events-none">
                <img src="assets/images/mock.png" 
                    class="max-w-[30%] max-h-[30%] opacity-30" 
                    alt="watermark">
            </div>
            <h2 class="text-xl font-bold mb-4">Occupant Detail</h2>
            <div class="flex flex-col items-center mb-4">
                    @* Photo *@
                    @if (PhotoByEmployee.TryGetValue(SelectedOccupant.EmployeeId, out var photos) && photos.Any())
                    {
                        <img src="@($"/secure-files/{photos.First().Path}")"
                            class="w-40 h-40 rounded-full mx-auto mb-4 object-cover" />
                    }
                    else
                    {
                        <div class="w-40 h-40 rounded-full bg-gray-200 mx-auto mb-4 flex items-center justify-center text-gray-500">
                            No Photo
                        </div>
                    }
                </div>
            <div class="space-y-2">
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Occupant Info</h4>
                    <ul class="list-disc ml-5 space-y-1">
                        <div>NRP: @SelectedOccupant.Employee?.NRP</div>
                        <div>Name: @SelectedOccupant.Employee?.Name</div>
                        <div>Gender: @SelectedOccupant.Employee?.Gender</div>
                        <div>Phone: @SelectedOccupant.Employee?.Phone</div>
                        <div>Position: @SelectedOccupant.Employee?.Position?.Name</div>
                        <div>Rank: @SelectedOccupant.Employee?.Rank?.Name</div>
                        <div>Status:
                         <span class="@GetStatusClass(SelectedOccupant.DepartedAt == null)">
                                    @(SelectedOccupant.DepartedAt == null ? "Active" : "Inactive")
                                </span>
                        </div>
                    </ul>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold mb-2">Building Info</h4>
                    <ul class="list-disc ml-5 space-y-1">
                        <div>Building / Floor: @SelectedOccupant.Room?.Building?.Name | @SelectedOccupant.Room?.Floor</div>
                        <div>Room: @SelectedOccupant.Room?.Name | @SelectedOccupant.Room?.RoomNo</div>
                        <div>Arrived: @SelectedOccupant.ArrivedAt.ToString("dd MMM yyyy")</div>
                        <div>Departed: @SelectedOccupant.DepartedAt?.ToString("dd MMM yyyy")</div>
                    </ul>
                </div>
                
                @if (PhotoByOccupant.TryGetValue(SelectedOccupant.Id, out var photoOcc) && photoOcc.Any())
                {
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Photo Attachment</h4>
                        <ul class="list-disc ml-5 space-y-1">
                            <div class="relative w-full flex justify-center">
                                <img src="@($"/secure-files/{photoOcc.First().Path}")"
                                    class="w-full h-48 rounded-md object-contain border" />
                                    <a href="@($"/secure-files/{photoOcc.First().Path}")" 
                                    download
                                    class="absolute top-2 right-2 bg-blue-600 text-white p-2 rounded-full shadow hover:bg-blue-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3" />
                                    </svg>
                                </a>
                            </div>
                        </ul>
                    </div>
                }
                @if (DocsByOccupant.TryGetValue(SelectedOccupant.Id, out var docs) && docs.Any())
                {
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Documents Attachment</h4>
                        <ul class="list-disc ml-5 space-y-1">
                            @foreach (var d in docs)
                            {
                                <li>
                                    <a href="@($"/secure-files/{d.Path}")" target="_blank" class="text-blue-600 hover:underline">@d.FileName</a>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
            <div class="flex justify-end mt-4">
                <button class="px-3 py-1 bg-red-500 text-white rounded" @onclick="()=>ShowDetailModal=false">Close</button>
            </div>
        </div>
    </div>
}

@* Modal Checkout *@
@if (ShowCheckoutModalFlag)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Checkout Occupant</h2>
            <label>Checkout Date:</label>
            <InputDate @bind-Value="CheckoutDate" class="w-full border rounded px-2 py-1 mb-4" />

            <div class="flex justify-end space-x-2">
                <button class="px-3 py-1 bg-gray-300 rounded" @onclick="()=>ShowCheckoutModalFlag=false">Cancel</button>
                <button class="px-3 py-1 bg-red-600 text-white rounded" @onclick="CheckoutOccupant">Checkout</button>
            </div>
        </div>
    </div>
}

@* Modal Transfer *@
@if (ShowTransferModalFlag)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Transfer Occupant</h2>
            <label>Select New Room:</label>
            <select class="w-full border rounded px-2 py-1 mb-4" @bind="TransferRoomId">
                <option value="">Select Room</option>
                @foreach(var room in Rooms)
                {
                    <option value="@room.Id">@room.RoomNo</option>
                }
            </select>

            <div class="flex justify-end space-x-2">
                <button class="px-3 py-1 bg-gray-300 rounded" @onclick="()=>ShowTransferModalFlag=false">Cancel</button>
                <button class="px-3 py-1 bg-yellow-600 text-white rounded" @onclick="TransferOccupant">Transfer</button>
            </div>
        </div>
    </div>
}

<ToastContainer @ref="toastContainer" />

@code {
    private bool isLoading = false;
    private ToastContainer? toastContainer;
    private string SearchTerm { get; set; } = "";
    private List<Occupant> Occupants;
    private List<Position> Positions = new();
    private List<Rank> Ranks = new();
    private List<Occupant> FilteredOccupants => string.IsNullOrEmpty(SearchTerm) 
        ? Occupants 
        : Occupants.Where(o => 
            (o.Employee?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
            (o.Employee?.Position?.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true)  ||
            (o.Employee?.NRP?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true)  ||
            (o.Employee?.Rank?.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
            (o.Room?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
            (o.Room?.Building?.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) 
        ).ToList();

    private bool ShowModal = false;
    private string ModalTitle = "Add Occupant";
    private int AddStep = 1;
    private string NRPInput;
    private Occupant SelectedOccupant = new();

    private List<Room> Rooms;

    // Checkout
    private bool ShowCheckoutModalFlag = false;
    private int CheckoutOccupantId;
    private DateTime? CheckoutDate = DateTime.Today;

    // Transfer
    private bool ShowTransferModalFlag = false;
    private int TransferOccupantId;
    private int? TransferRoomId;

    // Detail
    private bool ShowDetailModal = false;

    private IReadOnlyList<IBrowserFile>? PendingUploads;
    private IBrowserFile? PendingPhoto;
    private IReadOnlyList<IBrowserFile>? PendingDocs;

    // Dictionaries untuk file
    private Dictionary<int, List<FileUpload>> PhotoByEmployee = new();
    private Dictionary<int, List<FileUpload>> DocsByOccupant = new();
    private Dictionary<int, List<FileUpload>> PhotoByOccupant = new();

    protected override async Task OnInitializedAsync()
    {
        Occupants = await OccupantService.GetAllAsync();
        Rooms = await RoomService.GetAllAsync();
        var allPhotos = await FileService.GetFilesByCategoryAsync("EmployeePhoto");
        PhotoByEmployee = allPhotos
            .GroupBy(f => f.OwnerId)
            .ToDictionary(g => g.Key, g => g.ToList());

        // Load photo
        var allPhotos2 = await FileService.GetFilesByCategoryAsync("OccupantPhoto");
        PhotoByOccupant = allPhotos2
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

        // Load documents
        var allDocs = await FileService.GetFilesByCategoryAsync("OccupantDocs");
        DocsByOccupant = allDocs
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

    }

    private void ShowAddModal()
    {
        ModalTitle = "Add Occupant";
        ShowModal = true;
        AddStep = 1;
        SelectedOccupant = new();
        NRPInput = "";
    }

    private async Task OnNRPEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(NRPInput) && !isLoading)
        {
            
            try
            {
                isLoading = true;

                var emp = await EmployeeService.GetByNRPAsync(NRPInput);
                

                if (emp != null)
                {
                    var occ = await OccupantService.GetByEmployeeIdAsync(emp.Id);
                    if(occ != null && occ?.DepartedAt == null)
                    {
                        toastContainer?.ShowToast("Employee is Occupant Active!", "warning");
                        return;
                    }
                    SelectedOccupant.EmployeeId = emp.Id;
                    SelectedOccupant.Employee = emp;
                    AddStep = 2;
                }
                else
                {
                    toastContainer?.ShowToast("NRP not found!", "error");
                }
            }
            catch (Exception ex)
            {
                toastContainer?.ShowToast($"Error: {ex.Message}", "error");
            }
            finally
            {
                isLoading = false;
            }
        }
    }

    private async Task SearchNRP()
    {
        if (!string.IsNullOrWhiteSpace(NRPInput) && !isLoading)
        {
            await OnNRPEnter(new KeyboardEventArgs { Key = "Enter" });
        }
    }

    private void NextStep()
    {
        if(AddStep < 3) AddStep++;
    }

    private async Task SaveOccupant()
    {
        
        await OccupantService.AddAsync(SelectedOccupant);
        if (PendingPhoto != null)
            await FileService.SaveFileAsync(PendingPhoto, "OccupantPhoto", SelectedOccupant.Id);

        // Simpan dokumen
        if (PendingDocs?.Count > 0)
        {
            foreach (var doc in PendingDocs)
                await FileService.SaveFileAsync(doc, "OccupantDocs", SelectedOccupant.Id);
        }

        // Load photo
        var allPhotos2 = await FileService.GetFilesByCategoryAsync("OccupantPhoto");
        PhotoByOccupant = allPhotos2
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

        // Load documents
        var allDocs = await FileService.GetFilesByCategoryAsync("OccupantDocs");
        DocsByOccupant = allDocs
        .GroupBy(f => f.OwnerId)
        .ToDictionary(g => g.Key, g => g.ToList());

        var history = new OccupantHistory
            {
                OccupantId = SelectedOccupant.Id,
                Action = "CheckIn",
                RoomId = SelectedOccupant.RoomId,
                Notes = $"CheckIn room {SelectedOccupant.Room?.Name}"
            };
            await HistoryService.AddAsync(history);

        toastContainer?.ShowToast("Occupant saved!", "success");
        Occupants = await OccupantService.GetAllAsync();
        ShowModal = false;
    }

    private async Task ShowDetail(Occupant occ)
    {
        SelectedOccupant = occ;

        var allPhotos2 = await FileService.GetFilesByCategoryAsync("OccupantPhoto");
        PhotoByOccupant = allPhotos2.GroupBy(f => f.OwnerId)
                                    .ToDictionary(g => g.Key, g => g.ToList());

        var allDocs = await FileService.GetFilesByCategoryAsync("OccupantDocs");
        DocsByOccupant = allDocs.GroupBy(f => f.OwnerId)
                                .ToDictionary(g => g.Key, g => g.ToList());

        ShowDetailModal = true;
    }


    private void ShowCheckoutModal(int id)
    {
        CheckoutOccupantId = id;
        CheckoutDate = DateTime.Today;
        ShowCheckoutModalFlag = true;
    }

    private async Task CheckoutOccupant()
    {
        if (CheckoutOccupantId == 0 || CheckoutDate == null)
        return;

        // ambil fresh dari DbContext
        var occ = await OccupantService.GetByIdAsync(CheckoutOccupantId);
        if(occ?.DepartedAt != null )
        {
            toastContainer?.ShowToast("Occupant InActive!", "warning");
            return;
        }
        if (occ != null)
        {
            occ.DepartedAt = CheckoutDate.Value;
            await OccupantService.UpdateAsync(occ);
            var history = new OccupantHistory
            {
                OccupantId = occ.Id,
                Action = "Checkout",
                RoomId = occ.RoomId,
                Notes = $"Checkout from room {occ.Room?.Name}"
            };
            await HistoryService.AddAsync(history);
            toastContainer?.ShowToast("Occupant checked out!", "success");
            Occupants = await OccupantService.GetAllAsync(); // refresh
        }
        ShowCheckoutModalFlag = false;
    }

    private void ShowTransferModal(int id)
    {
        TransferOccupantId = id;
        TransferRoomId = null;
        ShowTransferModalFlag = true;
    }

    private async Task TransferOccupant()
    {
        if(TransferRoomId != null)
        {
            var occ = await OccupantService.GetByIdAsync(SelectedOccupant.Id);
            if(occ != null)
            {
                occ.RoomId = TransferRoomId.Value;
                occ.ArrivedAt = DateTime.Now;
                await OccupantService.UpdateAsync(occ); // aman karena instance baru
                var history = new OccupantHistory
                {
                    OccupantId = occ.Id,
                    Action = "Transfer",
                    RoomId = occ.RoomId,
                    Notes = $"Transfer from room {SelectedOccupant.Room.Name}"
                };
                await HistoryService.AddAsync(history);
                toastContainer?.ShowToast("Occupant transferred!", "success");
                Occupants = await OccupantService.GetAllAsync(); // refresh UI
            }
        }
        ShowTransferModalFlag = false;
    }

    private void OnPhotoSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file.ContentType.StartsWith("image/"))
            PendingPhoto = file;
        else
            toastContainer?.ShowToast("Photo File Ext. Not Allowed!", "Error");
    }

    private void OnDocsSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles()
        .Where(f => f.ContentType == "application/pdf")
        .ToList();
        if (files.Any())
            PendingDocs = files;
        else
            toastContainer?.ShowToast("Only PDF Allowed!", "Error");
    }

    private string GetStatusClass(bool isActive) => isActive ? "text-green-600 font-semibold" : "text-red-600 font-semibold";
}
