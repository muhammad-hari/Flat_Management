@page "/occupants"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IOccupantRepository OccupantService
@inject IPositionRepository PositionService
@inject IRankRepository RankService
@inject IEmployeeRepository EmployeeService
@inject IRoomRepository RoomService

<div class="bg-white rounded-lg shadow-sm p-6">
    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-lg border border-green-200">
        <h2 class="text-2xl font-semibold text-gray-800">Occupants Management</h2>
        <p class="text-gray-600 mt-1">Manage Occupants , CheckIn and CheckOut</p>
    </div>
</div>

<div class="p-6 space-y-6">

    <!-- Card Summary -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-6">
        <div class="bg-purple-800 text-white p-6 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Occupants</h2>
            <p class="text-2xl font-bold">@TotalOccupants</p>
        </div>
        <div class="bg-green-400 text-white p-6 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">New Occupant</h2>
            <p class="text-2xl font-bold">@NewOccupants</p>
        </div>
        <div class="bg-yellow-500 text-white p-6 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Occupant / Years</h2>
            <p class="text-2xl font-bold">@TotalYearsWorked</p>
        </div>
        <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Average Years</h2>
            <p class="text-2xl font-bold">@AverageYears.ToString("F1")</p>
        </div>
    </div>

    <!-- Search & Add -->
    <div class="flex justify-between items-center">
        <input type="text" placeholder="Search Occupant..." @bind="SearchTerm"
               class="px-4 py-2 w-1/3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" />
        <button @onclick="AddOccupant" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition">
            + Add Occupant
        </button>
    </div>

    <!-- Occupant Table -->
    <div class="overflow-x-auto mt-4">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2">Employee name</th>
                    <th class="px-4 py-2">NRP</th>
                    <th class="px-4 py-2">Phone</th>
                    <th class="px-4 py-2">Position</th>
                    <th class="px-4 py-2">Arrived Date</th>
                    <th class="px-4 py-2">Departed Date</th>
                    <th class="px-4 py-2">Room</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredOccupants != null)
                {
                    @foreach (var Occupant in FilteredOccupants)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">@Occupant.Employee?.Name</td>
                            <td class="px-4 py-2">@Occupant.Employee?.NRP</td>
                            <td class="px-4 py-2">@Occupant.Employee?.Phone</td>
                            <td class="px-4 py-2">@Occupant.Employee?.Position?.Name</td>
                            <td class="px-4 py-2">@Occupant.ArrivedAt.ToString("dd MMM yyyy")</td>
                            <td class="px-4 py-2">@Occupant.DepartedAt?.ToString("dd MMM yyyy")</td>
                            <td class="px-4 py-2">@Occupant.Room?.RoomNo</td>
                            <td class="px-4 py-2">
                                <span class="@GetStatusClass(Occupant.DepartedAt == null)">
                                    @(Occupant.DepartedAt == null ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap space-x-2">
                                <button class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm" @onclick="() => ShowDetail(Occupant)">Detail</button>
                                <button class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm" @onclick="() => EditOccupant(Occupant)">Edit</button>
                                <button class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm" @onclick="() => ConfirmDelete(Occupant.Id, Occupant.Employee?.Name)">Delete</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Add/Edit/Detail -->
@if (ShowModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg overflow-y-auto max-h-screen">
            <h2 class="text-xl font-bold mb-4">@ModalTitle</h2>

            @if (ModalMode == "Detail")
            {
                <!-- Detail View -->
                <div class="flex flex-col items-center mb-4">
                    @if (SelectedOccupant.Employee?.PhotoData != null)
                    {
                        var base64 = Convert.ToBase64String(SelectedOccupant.Employee.PhotoData);
                        <img src="data:image/png;base64,@base64" class="w-40 h-40 rounded-full mb-4" />
                    }
                    else
                    {
                        <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-gray-500">No Photo</span>
                        </div>
                    }
                </div>

                <div class="grid grid-cols-2 gap-2 text-gray-700">
                    <div class="font-semibold">Occupant Name</div><div>@SelectedOccupant.Employee?.Name</div>
                    <div class="font-semibold">NRP</div><div>@SelectedOccupant.Employee?.NRP</div>
                    <div class="font-semibold">Gender</div><div>@SelectedOccupant.Employee?.Gender</div>
                    <div class="font-semibold">Date of Birth</div><div>@SelectedOccupant.Employee?.DateOfBirth.ToString("dd MMM yyyy")</div>
                    <div class="font-semibold">Email</div><div>@SelectedOccupant.Employee?.Email</div>
                    <div class="font-semibold">Phone</div><div>@SelectedOccupant.Employee?.Phone</div>
                    <div class="font-semibold">Position</div><div>@SelectedOccupant.Employee?.Position?.Name</div>
                    <div class="font-semibold">Address</div><div>@SelectedOccupant.Employee?.Address</div>
                    <div class="font-semibold">Rank</div><div>@SelectedOccupant.Employee?.Rank?.Name</div>
                    <div class="font-semibold">Arrived Date</div><div>@SelectedOccupant.ArrivedAt.ToString("dd MMM yyyy")</div>
                    <div class="font-semibold">Status</div>
                    <div>
                        <span class="@GetStatusClass(SelectedOccupant.DepartedAt == null)">
                            @(SelectedOccupant.DepartedAt == null ? "Active" : "Inactive")
                        </span>
                    </div>
                    <div class="font-semibold">Period</div><div>@GetPeriod(SelectedOccupant.ArrivedAt)</div>
                </div>
            }
            else
            {
                <!-- Add / Edit Form -->
                <div class="space-y-2">
                    <!-- NRP Input -->
                    <input class="w-full px-3 py-2 border rounded"
                           placeholder="NRP"
                           @bind="NRPInput"
                           @onkeydown="OnNRPEnter" />

                    <!-- Employee Details (disabled until Employee ditemukan) -->
                    <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           placeholder="Occupant Name"
                           @bind="SelectedOccupant.Employee.Name"
                           disabled="@(!IsEmployeeLoaded)" />

                    <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           placeholder="Gender"
                           @bind="SelectedOccupant.Employee.Gender"
                           disabled="@(!IsEmployeeLoaded)" />

                    @* <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           type="date"
                           @bind="SelectedOccupant.Employee.DateOfBirth"
                           disabled="@(!IsEmployeeLoaded)" /> *@

                    @* <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           placeholder="Email"
                           @bind="SelectedOccupant.Employee.Email"
                           disabled="@(!IsEmployeeLoaded)" /> *@

                    <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           placeholder="Phone"
                           @bind="SelectedOccupant.Employee.Phone"
                           disabled="@(!IsEmployeeLoaded)" />

                    <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           placeholder="Position"
                           @bind="SelectedOccupant.Employee.Position.Name"
                           disabled="@(!IsEmployeeLoaded)" />

                    <input class="w-full px-3 py-2 border rounded bg-gray-100"
                           placeholder="Address"
                           @bind="SelectedOccupant.Employee.Address"
                           disabled="@(!IsEmployeeLoaded)" />

                    @* <div class="flex items-center space-x-2">
                        <div class="font-semibold">Active</div>
                        <input type="checkbox"
                               @bind="SelectedOccupant.Employee.IsActive"
                               disabled="@(!IsEmployeeLoaded)" />
                    </div> *@

                    <div class="font-semibold">Room</div>
                <select class="w-full mb-2 px-3 py-2 border rounded" @bind="SelectedOccupant.RoomId">
                    <option value="">Select Room</option>
                    @foreach (var room in Rooms)
                    {
                        <option value="@room.Id">@room.RoomNo</option>
                    }
                </select>

                <!-- Upload Photo -->
                <div class="mb-3">
                    <label class="font-semibold">Photo (image only)</label>
                    <InputFile OnChange="UploadPhoto" accept="image/*" />
                    @if (SelectedOccupant.PhotoData != null)
                    {
                        <img src="data:image/png;base64,@Convert.ToBase64String(SelectedOccupant.PhotoData)"
                            class="w-40 h-40 rounded-full mt-2" />
                    }
                </div>

                <!-- Upload Document -->
                <div class="mb-3">
                    <label class="font-semibold">Document (pdf/doc/docx)</label>
                    <InputFile OnChange="UploadDocument" accept=".pdf,.doc,.docx" />
                    @if (!string.IsNullOrEmpty(SelectedOccupant.DocumentName))
                    {
                        <p class="text-sm mt-1">Uploaded: @SelectedOccupant.DocumentName</p>
                    }
                </div>

                </div>

                <div class="flex justify-end space-x-2 mt-4">
                    <button class="px-4 py-2 bg-red-600 text-white rounded" @onclick="CloseModal">Close</button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded" @onclick="SaveOccupant" disabled="@(!IsEmployeeLoaded)">Save</button>
                </div>
            }
        </div>
    </div>
}


<!-- Confirm Delete Modal -->
@if (ShowConfirmModal)
{
    <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Delete</h3>
            <p class="text-gray-700 mb-6">@ConfirmMessage</p>
            <div class="flex justify-end space-x-3">
                <button class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg" @onclick="CancelDelete">Cancel</button>
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg" @onclick="DeleteConfirmed">Delete</button>
            </div>
        </div>
    </div>
}

<ToastContainer @ref="toastContainer" />

@code {
    private string NRPInput = "";
    private List<IBrowserFile> UploadedFiles = new();
    private ToastContainer? toastContainer;

    private List<Occupant> Occupants = new();
    private List<Position> Positions = new();
    private List<Room> Rooms = new();
    private List<Rank> Ranks = new();
    private string SearchTerm = "";
    private bool ShowModal = false;
    private string ModalTitle = "";
    private string ModalMode = "";
    private Occupant SelectedOccupant = new();
    private bool ShowConfirmModal = false;
    private string ConfirmMessage = "";
    private int OccupantIdToDelete;
    private bool IsEmployeeLoaded = false;

    @* private bool IsEmployeeLoaded => SelectedOccupant.Employee != null && !string.IsNullOrWhiteSpace(SelectedOccupant.Employee.NRP); *@

    protected override async Task OnInitializedAsync()
    {
        Occupants = await OccupantService.GetAllAsync();
        Positions = await PositionService.GetAllAsync();
        Ranks = await RankService.GetAllAsync();
    }

    private IEnumerable<Occupant> FilteredOccupants => Occupants
        .Where(u => string.IsNullOrWhiteSpace(SearchTerm) || u.Employee.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    private string GetStatusClass(bool active) =>
        active ? "px-2 py-1 text-xs bg-green-200 text-green-800 rounded-full" : "px-2 py-1 text-xs bg-red-200 text-red-800 rounded-full";

    private void ShowDetail(Occupant Occupant)
    {
        SelectedOccupant = Occupant ?? new Occupant { Employee = new Employee() };
        ModalTitle = "Occupant Detail";
        ModalMode = "Detail";
        ShowModal = true;
    }

    private void AddOccupant()
{
    SelectedOccupant = new Occupant
    {
        Employee = new Employee { IsActive = true, JoinDate = DateOnly.FromDateTime(DateTime.Now), Position = new Position(), Rank = new Rank() },
        ArrivedAt = DateTime.Now
    };
    NRPInput = "";
    ModalTitle = "Add Occupant";
    ModalMode = "Add";
    IsEmployeeLoaded = false;
    ShowModal = true;
}

private void EditOccupant(Occupant occupant)
{
    SelectedOccupant = occupant ?? new Occupant { Employee = new Employee { Position = new Position(), Rank = new Rank() } };
    NRPInput = SelectedOccupant.Employee?.NRP ?? "";
    ModalTitle = "Edit Occupant";
    ModalMode = "Edit";
    IsEmployeeLoaded = !string.IsNullOrWhiteSpace(NRPInput);
    ShowModal = true;
}


    private void CloseModal() => ShowModal = false;

    private async Task OnNRPEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(NRPInput))
        {
            var employee = await EmployeeService.GetByNRPAsync(NRPInput);
            if (employee != null)
            {
                SelectedOccupant.Employee = employee;
            }
            else
            {
                SelectedOccupant.Employee = new Employee
                {
                    NRP = NRPInput,
                    IsActive = true
                };
            }

            IsEmployeeLoaded = true;
            StateHasChanged();
        }
    }

    private async Task LoadEmployeeByNRPAsync(string nrp)
    {
        if (string.IsNullOrWhiteSpace(nrp))
            return;

        var employee = await EmployeeService.GetByNRPAsync(nrp);
        if (employee != null)
            SelectedOccupant.Employee = employee;
        else
            SelectedOccupant.Employee = new Employee { NRP = nrp, IsActive = true };

        StateHasChanged();
    }

    private async Task OnFilesChange(InputFileChangeEventArgs e)
    {
        UploadedFiles.Clear();
        foreach (var file in e.GetMultipleFiles())
        {
            UploadedFiles.Add(file);
            var buffer = new byte[file.Size];
            await file.OpenReadStream(10_000_000).ReadAsync(buffer);
            // Simpan buffer ke entity atau storage
        }
    }

    private int TotalOccupants => Occupants?.Count() ?? 0;
    private int NewOccupants => Occupants?.Count(u => u.Employee.JoinDate >= DateOnly.FromDateTime(DateTime.Now.AddYears(-1))) ?? 0;

    private int TotalYearsWorked => Occupants?.Sum(u =>
    {
        var join = u.Employee.JoinDate.ToDateTime(TimeOnly.MinValue);
        var now = DateTime.Now;
        int years = now.Year - join.Year;
        if (now.Month < join.Month || (now.Month == join.Month && now.Day < join.Day))
            years--;
        return years;
    }) ?? 0;

    private double AverageYears => TotalOccupants > 0 ? (double)TotalYearsWorked / TotalOccupants : 0;

    private string GetPeriod(DateTime joinDate)
    {
        var start = joinDate;
        var end = DateTime.Now;

        int years = end.Year - start.Year;
        int months = end.Month - start.Month;
        int days = end.Day - start.Day;

        if (days < 0)
        {
            months--;
            days += DateTime.DaysInMonth(start.Year, start.Month);
        }

        if (months < 0)
        {
            years--;
            months += 12;
        }

        return $"{years} tahun {months} bulan {days} hari";
    }

    private async Task UploadPhoto(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            using var ms = new MemoryStream();
            await file.OpenReadStream(10_000_000).CopyToAsync(ms);
            SelectedOccupant.PhotoData = ms.ToArray();
        }
    }

    private async Task UploadDocument(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var ext = Path.GetExtension(file.Name).ToLower();
            if (ext is ".pdf" or ".doc" or ".docx")
            {
                using var ms = new MemoryStream();
                await file.OpenReadStream(20_000_000).CopyToAsync(ms);
                SelectedOccupant.DocumentData = ms.ToArray();
                SelectedOccupant.DocumentName = file.Name;
            }
            else
            {
                toastContainer?.ShowToast($"Error: File harus pdf/doc/docx", "error");
            }
        }
    }

    private async Task SaveOccupant()
    {
        try
        {
            if (!IsEmployeeLoaded) return;

            if (ModalMode == "Add")
            {
                await OccupantService.AddAsync(SelectedOccupant);
                toastContainer?.ShowToast("Occupant berhasil ditambahkan!", "success");
            }
            else if (ModalMode == "Edit")
            {
                await OccupantService.UpdateAsync(SelectedOccupant);
                toastContainer?.ShowToast("Occupant berhasil diperbarui!", "success");
            }

            Occupants = await OccupantService.GetAllAsync();
            CloseModal();
        }
        catch (Exception ex)
        {
            toastContainer?.ShowToast($"Error: {ex.Message}", "error");
        }
    }

    private void ConfirmDelete(int id, string name)
    {
        OccupantIdToDelete = id;
        ConfirmMessage = $"Are you sure you want to delete Occupant \"{name}\"?";
        ShowConfirmModal = true;
    }

    private void CancelDelete() => ShowConfirmModal = false;

    private async Task DeleteConfirmed()
    {
        await OccupantService.DeleteAsync(OccupantIdToDelete);
        Occupants = await OccupantService.GetAllAsync();
        ShowConfirmModal = false;
        toastContainer?.ShowToast("Occupant berhasil dihapus!", "success");
    }

    private string NRPInputValue
    {
        get => SelectedOccupant.Employee?.NRP ?? "";
        set
        {
            NRPInput = value;
            _ = LoadEmployeeByNRPAsync(value);
        }
    }

    
}
