@page "/rooms"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IRoomRepository RoomService
@inject IFileService FileService
@inject IBuildingRepository BuildingService // New dependency
@inject IRoomCategoryRepository CategoryService // New dependency
@inject IRoomStatusRepository StatusService // New dependency
@inject IRoomConditionRepository ConditionService // New dependency
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedSessionStorage SessionStorage
@using System.Security.Claims

@using Microsoft.AspNetCore.Components.Forms 
@using Microsoft.AspNetCore.Components.Web.Virtualization 
@inject ToastService ToastService

<PageTitle>Rooms Management</PageTitle>

<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 border-b pb-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Room Management</h2>
            <p class="text-gray-500 mt-1">Manage Room Property, Maintenance and Status.</p>
        </div>
        
        <div class="flex items-center space-x-3 mt-4 md:mt-0 w-full md:w-auto">
            <div class="relative w-full md:w-64">
                <input value="@searchTerm" @oninput="HandleSearchTermChange" 
       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
       placeholder="Search Name, Code or Building..." />
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            
            <button class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-xl 
                            shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                            @onclick="AddRoom">
                <i class="fas fa-plus"></i> Add Room
            </button>
        </div>
    </div>

    @* --- ROOM CARD GRID --- *@
    <div class="grid gap-6" style="grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));">
        @if (Loading)
        {
            <div class="col-span-full text-center py-10 text-gray-500">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p class="text-lg">Loading rooms...</p>
            </div>
        }
        else
        {
            @foreach (var r in PagedRooms) 
            {
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 hover:shadow-2xl transition-all duration-300 flex flex-col">
                    <div class="relative">
                        @if (FilesByRoom.TryGetValue(r.Id, out var files) && files.Any())
                        {
                            <img src="@($"/secure-files/{files.First().Path}")"
                                class="w-full h-48 object-cover rounded-t-xl cursor-pointer"
                                @onclick="() => ShowPreview(r.Id, files.First().Path)" /> 
                            
                            @if (files.Count > 1)
                            {
                                <span class="absolute bottom-2 right-2 bg-black/60 text-white text-xs font-medium px-2 py-1 rounded-full">
                                    +@(files.Count - 1) Photos
                                </span>
                            }
                        }
                        else
                        {
                            <div class="w-full h-48 bg-gray-200 rounded-t-xl flex items-center justify-center text-gray-400">
                                <i class="fas fa-image fa-3x"></i>
                            </div>
                        }

                        <span class="absolute top-2 left-2 bg-indigo-600 text-white text-sm font-semibold px-3 py-1 rounded-full shadow-md">
                            @r.Building?.Name
                        </span>
                        
                        <span class="absolute top-2 right-2 @(r.IsAvailable ? "bg-green-500" : "bg-red-500") text-white text-xs font-semibold px-3 py-1 rounded-full">
                            @(r.IsAvailable ? "Available" : "Occupied")
                        </span>
                    </div>

                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-xl font-bold text-gray-800 truncate mb-1">@r.RoomNo - @r.Name</h3>
                        <div class="flex items-center text-sm text-gray-600 mb-2">
                            <i class="fas fa-layer-group mr-2 text-gray-400"></i>
                            <span class="truncate">Category: @r.Category?.Name | Floor: @r.Floor</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600 mb-2">
                            <i class="fas fa-info-circle mr-2 text-gray-400"></i>
                            <span class="truncate">Status: @r.Status?.Name | Condition: @r.Condition?.Name</span>
                        </div>
                        <p class="text-gray-500 text-sm line-clamp-2 mb-3 flex-grow">@r.Details</p>

                        <div class="mt-3 flex justify-end gap-3 pt-3 border-t border-gray-100">
                            <button class="flex items-center gap-1 px-3 py-1 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition-colors" 
                                    @onclick="() => EditRoom(r)">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="flex items-center gap-1 px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
                                    @onclick="() => ConfirmDelete(r.Id, r.Name)">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            }
            
            @if (!FilteredRooms.Any() && !Loading)
            {
                <div class="col-span-full text-center py-10 text-gray-500">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p class="text-lg">No Rooms found.</p>
                </div>
            }
        }
    </div>

    @* --- PAGINATION --- *@
    @if (FilteredRooms.Any() && !Loading)
    {
        <div class="mt-8 flex justify-between items-center p-4 bg-gray-50 rounded-xl shadow-inner">
            <span class="text-sm text-gray-600">
                Showing <strong>@((CurrentPage - 1) * PageSize + 1)</strong> to <strong>@(Math.Min(CurrentPage * PageSize, FilteredRooms.Count()))</strong> of <strong>@FilteredRooms.Count()</strong> entries
            </span>
            <div class="flex space-x-2">
                <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == 1 ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                        @onclick="() => ChangePage(CurrentPage - 1)"
                        disabled="@(CurrentPage == 1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>

                @for (int i = 1; i <= TotalPages; i++)
                {
                    var pageNumber = i;
                    <button class="px-4 py-2 text-sm rounded-lg font-medium @(i == CurrentPage ? "bg-blue-600 text-white shadow-md" : "bg-white hover:bg-blue-50 border text-gray-700")"
                            @onclick="() => ChangePage(pageNumber)">
                        @i
                    </button>
                }

                <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == TotalPages ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                        @onclick="() => ChangePage(CurrentPage + 1)"
                        disabled="@(CurrentPage == TotalPages)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    }

    @* --- ADD/EDIT MODAL (REFITTED) --- *@
    @if (ShowModal)
    {
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ease-out">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl relative animate-zoom-in">
                
                <div class="border-b px-6 py-4 flex justify-between items-center">
                <div class="absolute inset-0 flex justify-center items-center pointer-events-none">
                    <img src="assets/images/mock.png" class="max-w-[50%] max-h-[50%] opacity-30" alt="watermark">
                </div>
                    <h2 class="text-2xl font-bold text-gray-800">@ModalTitle</h2>
                    <button class="text-gray-400 hover:text-gray-600" @onclick="() => ShowModal = false">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>

                <EditForm Model="@Selected" OnValidSubmit="@SaveRoom" class="p-6">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" />
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        @* Row 1: Name, Code, Room No *@
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Room Name</label>
                            <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" 
                                        @bind-Value="Selected.Name" placeholder="e.g., Lab Komputer" />
                            <ValidationMessage For="@(() => Selected.Name)" />
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Room Code</label>
                            <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" 
                                        @bind-Value="Selected.RoomCode" placeholder="e.g., LKM-001" />
                            <ValidationMessage For="@(() => Selected.RoomCode)" />
                        </div>

                         <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Room No</label>
                            <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" 
                                        @bind-Value="Selected.RoomNo" placeholder="e.g., A.1.01" />
                            <ValidationMessage For="@(() => Selected.RoomNo)" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        @* Row 2: Building, Floor, Size, Total Occupant *@
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Building</label>
                            <InputSelect @bind-Value="Selected.BuildingId" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500">
                                <option value="0">Select Building</option>
                                @foreach (var building in ActiveBuildings)
                                {
                                    <option value="@building.Id">@building.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Selected.BuildingId)" />
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Floor</label>
                            <InputNumber class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" 
                                        @bind-Value="Selected.Floor" placeholder="Floor number" />
                            <ValidationMessage For="@(() => Selected.Floor)" />
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Size (sqm)</label>
                            <InputNumber class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" 
                                        @bind-Value="Selected.Size" placeholder="Room Size" />
                            <ValidationMessage For="@(() => Selected.Size)" />
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Max Occupants</label>
                            <InputNumber class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" 
                                        @bind-Value="Selected.TotalOccupant" placeholder="Max Occupants" />
                            <ValidationMessage For="@(() => Selected.TotalOccupant)" />
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        @* Row 3: Category, Status, Condition *@
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Category</label>
                            <InputSelect @bind-Value="Selected.CategoryId" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500">
                                <option value="0">Select Category</option>
                                @foreach (var category in Categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Selected.CategoryId)" />
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Status</label>
                            <InputSelect @bind-Value="Selected.StatusId" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500">
                                <option value="0">Select Status</option>
                                @foreach (var status in Statuses)
                                {
                                    <option value="@status.Id">@status.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Selected.StatusId)" />
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Condition</label>
                            <InputSelect @bind-Value="Selected.ConditionId" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500">
                                <option value="0">Select Condition</option>
                                @foreach (var condition in Conditions)
                                {
                                    <option value="@condition.Id">@condition.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => Selected.ConditionId)" />
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-1">Details</label>
                        <InputTextArea class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500 h-24" 
                                        @bind-Value="Selected.Details" placeholder="Room Description or extra details" />
                        <ValidationMessage For="@(() => Selected.Details)" />
                    </div>

                    <div class="mb-6">
                        <label class="flex items-center gap-2 text-gray-700 font-medium cursor-pointer">
                            <InputCheckbox @bind-Value="Selected.IsAvailable" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" /> 
                            Room is Available (Check this if the room is not occupied/in maintenance)
                        </label>
                    </div>

                    @* --- IMAGE MANAGEMENT SECTION (KEPT AS IS) --- *@
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h4 class="font-semibold text-gray-800 mb-3">Image Management</h4>

                        @if (EditFiles.Any())
                        {
                            <div class="mb-3">
                                <div class="text-sm font-medium mb-2 text-gray-600">Existing Images (@EditFiles.Count)</div>
                                <div class="flex gap-3 flex-wrap">
                                    @foreach (var f in EditFiles)
                                    {
                                        <div class="relative group">
                                            <img src="@($"/secure-files/{f.Path}")"
                                                class="h-16 w-16 object-cover rounded-lg border-2 border-transparent hover:border-blue-500 cursor-pointer transition"
                                                @onclick="() => ShowPreview(Selected.Id, f.Path)" />
                                            <button type="button"
                                                    class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 text-sm flex items-center justify-center shadow-lg"
                                                    @onclick="() => RemoveExistingFile(f)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <div>
                            <div class="text-sm font-medium mb-2 text-gray-600">Upload New Files</div>
                            <InputFile OnChange="OnFilesSelected" multiple 
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                            @if (PendingUploads?.Count > 0)
                            {
                                <p class="text-xs text-blue-600 mt-1">@PendingUploads.Count file ready to upload.</p>
                            }
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                        <button type="button" 
                                class="bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-2 rounded-lg transition flex items-center gap-2"
                                @onclick="() => ShowModal = false">
                            <i class="fas fa-ban"></i> Cancel
                        </button>
                        <button type="submit" 
                                class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-save"></i> Save Room
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @* --- PREVIEW/CONFIRMATION MODALS (KEPT AS IS) --- *@
    @if (!string.IsNullOrEmpty(PreviewPath))
    {
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 transition-opacity duration-300 ease-out" 
                @onclick="() => PreviewPath = null">
            
            <div class="relative flex items-center justify-center" @onclick:stopPropagation="true">

                <button class="absolute left-4 z-10 p-3 bg-white/30 backdrop-blur-sm text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/50 transition disabled:opacity-50"
                        @onclick="PrevImage" disabled="@(CurrentFileIndex == 0)">
                    <i class="fas fa-chevron-left fa-lg"></i>
                </button>

                <img src="@($"/secure-files/{PreviewPath}")" 
                        class="max-h-[90vh] max-w-[80vw] rounded-xl shadow-2xl object-contain transition-transform duration-300" />
                
                <button class="absolute right-4 z-10 p-3 bg-white/30 backdrop-blur-sm text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/50 transition disabled:opacity-50"
                        @onclick="NextImage" disabled="@(CurrentFileIndex >= CurrentFileList.Count - 1)">
                    <i class="fas fa-chevron-right fa-lg"></i>
                </button>

                <button class="absolute top-4 right-4 z-20 bg-white/30 backdrop-blur-sm text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-white/50 transition"
                        @onclick="() => PreviewPath = null">
                    <i class="fas fa-times"></i>
                </button>

                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white text-xs px-3 py-1 rounded-full">
                    @(CurrentFileIndex + 1) of @CurrentFileList.Count
                </div>
            </div>
        </div>
    }

    @if (ShowConfirmModal)
    {
        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 animate-slide-up">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2 text-red-600">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Delete
                </h3>
                <p class="text-gray-700 mb-6">@ConfirmMessage</p>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium" 
                            @onclick="CancelDelete">Cancel</button>
                    <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
                            @onclick="DeleteConfirmed">Delete</button>
                </div>
            </div>
        </div>
    }
</div>

<ToastContainer @ref="toastContainer" />

@code {
    // NOTE: Assuming the existence of Building, RoomCategory, RoomStatus, RoomCondition entities
    // and IBuildingRepository, IRoomCategoryRepository, etc. interfaces in MyApp.Core.Entities/Interfaces.

    // Properti Toast
    private ToastContainer? toastContainer; 
    
    // Properti Data
    private List<Room> Rooms = new();
    private Dictionary<int, List<FileUpload>> FilesByRoom = new();
    private List<Building> AllBuildings = new(); // All buildings
    private List<RoomCategory> Categories = new(); // All categories
    private List<RoomStatus> Statuses = new(); // All statuses
    private List<RoomCondition> Conditions = new(); // All conditions
    private bool Loading = true;
    
    // Properti Modal
    private bool ShowModal;
    private string ModalTitle = "";
    private Room Selected = new();
    private IReadOnlyList<IBrowserFile>? PendingUploads;
    private List<FileUpload> EditFiles = new();
    
    // Properti Preview/Gallery
    private string? PreviewPath;
    private List<FileUpload> CurrentFileList = new(); 
    private int CurrentFileIndex = 0;
    
    // Properti Search & Delete
    private string searchTerm = string.Empty;
    private bool ShowConfirmModal = false;
    private int RoomIdToDelete;
    private MarkupString ConfirmMessage;

    // Properti Pagination
    private const int PageSize = 12;
    private int CurrentPage = 1;

    // Computed Properties untuk Dropdown
    private IEnumerable<Building> ActiveBuildings => AllBuildings.Where(b => b.IsActive); // Assuming Building has an IsActive property.

    // Computed Properties untuk Pagination
    private int TotalPages => (int)Math.Ceiling(FilteredRooms.Count() / (double)PageSize);
    
    private IEnumerable<Room> FilteredRooms =>
        string.IsNullOrWhiteSpace(searchTerm)
        ? Rooms
        : Rooms.Where(r =>
        (r.Name ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
        (r.RoomNo ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
        (r.RoomCode ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
        (r.Building?.Name ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
    
    private IEnumerable<Room> PagedRooms =>
        FilteredRooms.Skip((CurrentPage - 1) * PageSize).Take(PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadSupportingData();
        Loading = false;
    }

    private async Task LoadData()
    {
        Rooms = await RoomService.GetAllAsync();
        FilesByRoom.Clear();
        foreach (var r in Rooms)
        {
            var files = await FileService.GetFilesAsync("Room", r.Id);
            FilesByRoom[r.Id] = files.ToList();
        }
        CurrentPage = 1; 
    }
    
    private async Task LoadSupportingData()
    {
        // Assuming your repository methods exist for these entities
        AllBuildings = await BuildingService.GetAllAsync();
        Categories = await CategoryService.GetAllAsync();
        Statuses = await StatusService.GetAllAsync();
        Conditions = await ConditionService.GetAllAsync();
    }

    // Fungsi untuk mengurus perubahan halaman
    private void ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
        }
    }
    
    // Fungsi untuk mengatur ulang halaman saat pencarian berubah
    private void HandleSearchTermChange(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        // Reset halaman ke 1 setiap kali search term berubah
        CurrentPage = 1; 
    }

    // --- CRUD METHODS ---
    
    // Method: AddRoom
    private async Task AddRoom()
    {
        var claims = await SessionStorage.GetAsync<Dictionary<string, string>>("claims");
        string? username = null;
        claims.Value?.TryGetValue(ClaimTypes.Name, out username);

        Selected = new Room
        {
            CreatedBy = username ?? "unknown",
            TotalOccupant = 1,
            Floor = 1,
            Size = 10,
            IsAvailable = true,
            BuildingId = ActiveBuildings.FirstOrDefault()?.Id ?? 0, // Set default to first active building
            CategoryId = Categories.FirstOrDefault()?.Id ?? 0,
            StatusId = Statuses.FirstOrDefault()?.Id ?? 0,
            ConditionId = Conditions.FirstOrDefault()?.Id ?? 0
        };
        EditFiles.Clear();
        ModalTitle = "Add New Room";
        PendingUploads = null;
        ShowModal = true;
    }

    // Method: EditRoom
    private void EditRoom(Room r)
    {
        // Clone the room for editing
        Selected = new Room
        {
            Id = r.Id,
            Name = r.Name,
            RoomNo = r.RoomNo,
            RoomCode = r.RoomCode,
            BuildingId = r.BuildingId,
            CategoryId = r.CategoryId,
            StatusId = r.StatusId,
            ConditionId = r.ConditionId,
            TotalOccupant = r.TotalOccupant,
            Floor = r.Floor,
            Size = r.Size,
            IsAvailable = r.IsAvailable,
            Details = r.Details,
            CreatedBy = r.CreatedBy,
            CreatedAt = r.CreatedAt // Preserve original creation time
        };

        // Memastikan EditFiles diisi dari FilesByRoom
        EditFiles = FilesByRoom.TryGetValue(r.Id, out var f) ? f.ToList() : new();
        PendingUploads = null;
        ModalTitle = $"Edit Room: {r.Name}";
        ShowModal = true;
    }

    private void OnFilesSelected(InputFileChangeEventArgs e) => PendingUploads = e.GetMultipleFiles();

    private async Task SaveRoom()
    {
        bool isNew = Selected.Id == 0;
        
        // Update UpdatedAt
        Selected.UpdatedAt = DateTime.UtcNow;

        if (isNew)
            await RoomService.AddAsync(Selected);
        else
            await RoomService.UpdateAsync(Selected);

        if (PendingUploads?.Count > 0)
            foreach (var f in PendingUploads)
                await FileService.SaveFileAsync(f, "Room", Selected.Id);

        // Menggunakan toastContainer
        ToastService.ShowSuccess($"Room '{(isNew ? Selected.Name : "Data")}' successfully {(isNew ? "added" : "updated")}.");
        
        ShowModal = false;
        await LoadData();
    }

    private async Task RemoveExistingFile(FileUpload file)
    {
        await FileService.DeleteFileAsync(file.Id);
        EditFiles.Remove(file);
        if (FilesByRoom.TryGetValue(Selected.Id, out var list))
            list.RemoveAll(f => f.Id == file.Id);
            
        // Menggunakan toastContainer
        ToastService.ShowInfo("Image removed. Save the Room to confirm change.");
        
        StateHasChanged();
    }

    private async Task DeleteConfirmed()
    {
        if (RoomIdToDelete == 0) return; 

    // Panggil logika penghapusan
        var success = await RoomService.DeleteAsync(RoomIdToDelete);
        if(success)
        {
             await LoadData();
            ShowConfirmModal = false;
            ToastService.ShowInfo("Data successfully deleted!");
        }
        else
        {
            // Tampilkan pesan kesalahan yang spesifik (Foreign Key Constraint)
            ToastService.ShowWarning("Data failed deleted!, Any Occupant In this Room");
            ShowConfirmModal = false;
        }
       
    }

    private void CancelDelete()
    {
        ShowConfirmModal = false;
    }
    
    private void ConfirmDelete(int id, string name)
    {
        RoomIdToDelete = id;
        ConfirmMessage = new MarkupString(
        $"Are you sure you want to delete the Room <b>\"{name}\"</b>? This action cannot be undone."
        );
        ShowConfirmModal = true;
    }

    // --- CAROUSEL METHODS ---

    // Method: ShowPreview (for Carousel)
    private void ShowPreview(int roomId, string path)
    {
        if (FilesByRoom.TryGetValue(roomId, out var files))
        {
            CurrentFileList = files.ToList();
            CurrentFileIndex = CurrentFileList.FindIndex(f => f.Path == path);
            PreviewPath = path;
        }
    }

    // Method: NextImage
    private void NextImage()
    {
        if (CurrentFileIndex < CurrentFileList.Count - 1)
        {
            CurrentFileIndex++;
            PreviewPath = CurrentFileList[CurrentFileIndex].Path;
        }
    }

    // Method: PrevImage
    private void PrevImage()
    {
        if (CurrentFileIndex > 0)
        {
            CurrentFileIndex--;
            PreviewPath = CurrentFileList[CurrentFileIndex].Path;
        }
    }
}