@page "/access-menu"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Forms
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IMenuService MenuService
@inject ToastService ToastService
@inject IPermissionService PermissionService
@inject NavigationManager NavigationManager

<PageTitle>Menu Management</PageTitle>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-gradient-to-br from-blue-600 to-blue-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-list fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Total Menus</h2>
            <p class="text-2xl font-bold">@Menus.Count</p>
        </div>
    </div>
    <div class="bg-gradient-to-br from-green-600 to-green-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-check-circle fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Active</h2>
            <p class="text-2xl font-bold">@Menus.Count(m => m.IsActive)</p>
        </div>
    </div>
    <div class="bg-gradient-to-br from-red-600 to-red-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-ban fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Inactive</h2>
            <p class="text-2xl font-bold">@Menus.Count(m => !m.IsActive)</p>
        </div>
    </div>
    <div class="bg-gradient-to-br from-purple-600 to-purple-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-sitemap fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Parent Menus</h2>
            <p class="text-2xl font-bold">@Menus.Count(m => m.ParentId == null)</p>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 border-b pb-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Menu Management</h2>
            <p class="text-gray-500 mt-1">Manage system menus and navigation.</p>
        </div>
        <div class="flex items-center space-x-3 mt-4 md:mt-0 w-full md:w-auto">
            <div class="relative w-full md:w-64">
                <input value="@searchTerm" @oninput="HandleSearchTermChange"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
                    placeholder="Search Menu Name or Code..." />
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            @if (CanCreate)
            {
                <button class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                    @onclick="AddMenu">
                    <i class="fas fa-plus"></i> Add Menu
                </button>
            }
        </div>
    </div>

    @* --- MENU TABLE --- *@
    @if (Loading)
    {
        <div class="col-span-full text-center py-10 text-gray-500">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p class="text-lg">Loading menus...</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-b from-blue-700 to-black">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Icon</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">URL</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Parent</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Order</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var m in PagedMenus)
                    {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">@m.Code</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">@m.Name</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-@m.IconName @m.Color"></i>
                                    <span class="text-xs text-gray-500">@m.IconName</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">@(string.IsNullOrEmpty(m.Url) ? "-" : m.Url)</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">@(m.Parent?.Name ?? "-")</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">@m.Order</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="@(m.IsActive ? "bg-green-100 text-green-700 px-2 py-1 rounded-full" : "bg-red-100 text-red-700 px-2 py-1 rounded-full")">
                                    @(m.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                @if (CanView)
                                {
                                    <button class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-100 transition"
                                        @onclick="() => ShowDetail(m)">
                                        <i class="fas fa-eye mr-1"></i> Detail
                                    </button>
                                }
                                @if (CanUpdate)
                                {
                                    <button class="text-indigo-600 hover:text-indigo-900 p-2 rounded-lg hover:bg-indigo-100 transition"
                                        @onclick="() => EditMenu(m)">
                                        <i class="fas fa-edit mr-1"></i> Edit
                                    </button>
                                }
                                @if (CanDelete)
                                {
                                    <button class="text-red-600 hover:text-red-900 p-2 rounded-lg hover:bg-red-100 transition"
                                        @onclick="() => ConfirmDelete(m.Id, m.Name)">
                                        <i class="fas fa-trash-alt mr-1"></i> Delete
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (!FilteredMenus.Any() && !Loading)
        {
            <div class="col-span-full text-center py-10 text-gray-500">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p class="text-lg">No Menus found.</p>
            </div>
        }
    }

    @* --- PAGINATION --- *@
    @if (FilteredMenus.Any() && !Loading && TotalPages > 1)
    {
        <div class="mt-8 flex justify-between items-center p-4 bg-gray-50 rounded-xl shadow-inner">
            <span class="text-sm text-gray-600">
                Showing <strong>@((CurrentPage - 1) * PageSize + 1)</strong> to <strong>@(Math.Min(CurrentPage * PageSize, FilteredMenus.Count()))</strong> of <strong>@FilteredMenus.Count()</strong> entries
            </span>
            <div class="flex space-x-2">
                <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == 1 ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                    @onclick="() => ChangePage(CurrentPage - 1)" disabled="@(CurrentPage == 1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                @for (int i = 1; i <= TotalPages; i++)
                {
                    var pageNumber = i;
                    <button class="px-4 py-2 text-sm rounded-lg font-medium @(i == CurrentPage ? "bg-blue-600 text-white shadow-md" : "bg-white hover:bg-blue-50 border text-gray-700")"
                        @onclick="() => ChangePage(pageNumber)">@i</button>
                }
                <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == TotalPages ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                    @onclick="() => ChangePage(CurrentPage + 1)" disabled="@(CurrentPage == TotalPages)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    }

    @* --- ADD/EDIT/DETAIL MODAL --- *@
    @if (ShowModal)
    {
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ease-out">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl relative animate-zoom-in">
                <div class="border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">
                        @if (ModalMode == "Detail")
                        {
                            <i class="fas fa-eye text-green-600 mr-2"></i>
                        }
                        else if (ModalMode == "Add")
                        {
                            <i class="fas fa-plus text-green-600 mr-2"></i>
                        }
                        else
                        {
                            <i class="fas fa-edit text-blue-600 mr-2"></i>
                        }
                        @ModalTitle
                    </h2>
                    <button class="text-gray-400 hover:text-gray-600" @onclick="() => ShowModal = false">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                @if (ModalMode == "Detail")
                {
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-700">
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900 border-b pb-2">Menu Info</h3>
                                <p><strong>Code:</strong> @SelectedMenu.Code</p>
                                <p><strong>Name:</strong> @SelectedMenu.Name</p>
                                <p><strong>Icon:</strong> <i class="fas fa-@SelectedMenu.IconName @SelectedMenu.Color mr-2"></i>@SelectedMenu.IconName</p>
                                <p><strong>Color:</strong> <span class="@SelectedMenu.Color">@SelectedMenu.Color</span></p>
                                <p><strong>URL:</strong> @(string.IsNullOrEmpty(SelectedMenu.Url) ? "-" : SelectedMenu.Url)</p>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900 border-b pb-2">Additional Info</h3>
                                <p><strong>Parent:</strong> @(SelectedMenu.Parent?.Name ?? "None")</p>
                                <p><strong>Order:</strong> @SelectedMenu.Order</p>
                                <p><strong>Status:</strong> @(SelectedMenu.IsActive ? "Active" : "Inactive")</p>
                                <p><strong>Created At:</strong> @SelectedMenu.CreatedAt.ToShortDateString()</p>
                                @if (SelectedMenu.UpdatedAt.HasValue)
                                {
                                    <p><strong>Last Updated:</strong> @SelectedMenu.UpdatedAt.Value.ToShortDateString()</p>
                                }
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold px-5 py-2 rounded-lg transition" @onclick="() => ShowModal = false">Close</button>
                        </div>
                    </div>
                }
                else
                {
                    <EditForm Model="@SelectedMenu" OnValidSubmit="SaveMenu" class="p-6">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Code</label>
                                <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.Code" placeholder="Menu Code" />
                                <ValidationMessage For="@(() => SelectedMenu.Code)" />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Name</label>
                                <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.Name" placeholder="Menu Name" />
                                <ValidationMessage For="@(() => SelectedMenu.Name)" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Icon Name</label>
                                <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.IconName" placeholder="e.g., home, users" />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Color</label>
                                <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.Color" placeholder="e.g., text-blue-600" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">URL</label>
                                <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.Url" placeholder="/path/to/page" />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Parent Menu</label>
                                <InputSelect class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.ParentId">
                                    <option value="">None (Root Menu)</option>
                                    @foreach (var parent in ParentMenus)
                                    {
                                        <option value="@parent.Id">@parent.Name</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Order</label>
                                <InputNumber class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedMenu.Order" />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Status</label>
                                <InputCheckbox class="mr-2" @bind-Value="SelectedMenu.IsActive" /> Active
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-5 py-2 rounded-lg transition flex items-center gap-2" @onclick="() => ShowModal = false">
                                <i class="fas fa-ban"></i> Cancel
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-save"></i> Save Menu
                            </button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    }

    @* --- CONFIRMATION MODAL --- *@
    @if (ShowConfirmModal)
    {
        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 animate-slide-up">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2 text-red-600">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Delete
                </h3>
                <p class="text-gray-700 mb-6">@ConfirmMessage</p>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium" @onclick="CancelDelete">Cancel</button>
                    <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium" @onclick="DeleteConfirmed">Delete</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Menu> Menus = new();
    private List<Menu> ParentMenus = new();
    private bool Loading = true;
    private string searchTerm = string.Empty;
    private bool ShowModal;
    private string ModalTitle = "";
    private string ModalMode = "";
    private Menu SelectedMenu = new();
    private bool ShowConfirmModal;
    private string ConfirmMessage = "";
    private int MenuIdToDelete;
    private int CurrentPage = 1;
    private const int PageSize = 10;
    private int TotalPages => (int)Math.Ceiling(FilteredMenus.Count() / (double)PageSize);

    // Add these properties at the top
    private bool CanView = false;
    private bool CanCreate = false;
    private bool CanUpdate = false;
    private bool CanDelete = false;

    protected override async Task OnInitializedAsync()
    {
        // Check permissions first
        CanView = await PermissionService.HasPermissionAsync("access-menu", "view");
        if (!CanView)
        {
            NavigationManager.NavigateTo("/unauthorized");
            return;
        }

        CanCreate = await PermissionService.HasPermissionAsync("access-menu", "create");
        CanUpdate = await PermissionService.HasPermissionAsync("access-menu", "update");
        CanDelete = await PermissionService.HasPermissionAsync("access-menu", "delete");

        await LoadMenus();
        Loading = false;
    }

    private async Task LoadMenus()
    {
        Menus = await MenuService.GetAllAsync();
        ParentMenus = Menus.Where(m => m.ParentId == null).ToList();
        CurrentPage = 1;
    }

    private IEnumerable<Menu> FilteredMenus =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? Menus
            : Menus.Where(m =>
                (m.Code ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (m.Name ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<Menu> PagedMenus =>
        FilteredMenus.Skip((CurrentPage - 1) * PageSize).Take(PageSize);

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
        }
    }

    private void HandleSearchTermChange(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        CurrentPage = 1;
        StateHasChanged();
    }

    private void AddMenu()
    {
        if (!CanCreate)
        {
            ToastService.ShowError("You don't have permission to add menus");
            return;
        }

        SelectedMenu = new Menu { Order = Menus.Count + 1 };
        ModalMode = "Add";
        ModalTitle = "Add New Menu";
        ShowModal = true;
    }

    private void EditMenu(Menu menu)
    {
        if (!CanUpdate)
        {
            ToastService.ShowError("You don't have permission to edit menus");
            return;
        }

        SelectedMenu = new Menu
        {
            Id = menu.Id,
            Code = menu.Code,
            Name = menu.Name,
            IconName = menu.IconName,
            Color = menu.Color,
            Url = menu.Url,
            ParentId = menu.ParentId,
            Order = menu.Order,
            IsActive = menu.IsActive,
            CreatedAt = menu.CreatedAt,
            UpdatedAt = menu.UpdatedAt
        };
        ModalMode = "Edit";
        ModalTitle = "Edit Menu";
        ShowModal = true;
    }

    private void ShowDetail(Menu menu)
    {
        SelectedMenu = menu;
        ModalMode = "Detail";
        ModalTitle = $"Menu Detail: {menu.Name}";
        ShowModal = true;
    }

    private void CancelDelete() => ShowConfirmModal = false;

    private void ConfirmDelete(int id, string name)
    {
        if (!CanDelete)
        {
            ToastService.ShowError("You don't have permission to delete menus");
            return;
        }

        MenuIdToDelete = id;
        ConfirmMessage = $"Are you sure you want to delete \"{name}\"?";
        ShowConfirmModal = true;
    }

    private async Task SaveMenu()
    {
        if ((SelectedMenu.Id == 0 && !CanCreate) || (SelectedMenu.Id != 0 && !CanUpdate))
        {
            await ToastService.ShowError("You don't have permission to perform this action");
            return;
        }

        if (string.IsNullOrWhiteSpace(SelectedMenu.Code) || string.IsNullOrWhiteSpace(SelectedMenu.Name))
        {
            await ToastService.ShowWarning("Code and Name are required.");
            return;
        }

        try
        {
            if (SelectedMenu.Id == 0)
            {
                await MenuService.AddAsync(SelectedMenu);
                await ToastService.ShowSuccess("Menu added successfully!");
            }
            else
            {
                SelectedMenu.UpdatedAt = DateTime.UtcNow;
                await MenuService.UpdateAsync(SelectedMenu);
                await ToastService.ShowInfo("Menu updated successfully!");
            }
            await LoadMenus();
            ShowModal = false;
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error: {ex.Message}");
        }
    }

    private async Task DeleteConfirmed()
    {
        if (!CanDelete)
        {
            await ToastService.ShowError("You don't have permission to delete menus");
            return;
        }

        try
        {
            await MenuService.DeleteAsync(MenuIdToDelete);
            await LoadMenus();
            await ToastService.ShowInfo("Menu deleted successfully!");
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            ShowConfirmModal = false;
        }
    }
}