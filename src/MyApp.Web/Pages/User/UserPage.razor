
@page "/users"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Forms
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces

@inherits AppBase
@inject IUserRepository UserService
@inject IRoleRepository RoleService
@inject ToastService ToastService
@inject HttpClient Http

<PageTitle>User Management</PageTitle>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-gradient-to-br from-blue-600 to-blue-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-users fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Total Users</h2>
            <p class="text-2xl font-bold">@Users.Count</p>
        </div>
    </div>
    <div class="bg-gradient-to-br from-red-600 to-red-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-ban fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Blocked</h2>
            <p class="text-2xl font-bold">@Users.Count(u => u.IsBlocked)</p>
        </div>
    </div>
    <div class="bg-gradient-to-br from-gray-600 to-gray-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-trash-alt fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Deleted</h2>
            <p class="text-2xl font-bold">@Users.Count(u => u.IsDeleted)</p>
        </div>
    </div>
    <div class="bg-gradient-to-br from-green-600 to-green-900 text-white p-5 rounded-2xl shadow-lg flex items-center gap-4">
        <div class="bg-white/20 rounded-full p-3"><i class="fas fa-check-circle fa-2x"></i></div>
        <div>
            <h2 class="text-lg font-semibold">Active</h2>
            <p class="text-2xl font-bold">@Users.Count(u => u.IsActive)</p>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 border-b pb-4">
        <div>
            <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">User Management</h2>
            <p class="text-gray-500 mt-1">Manage user contact details and contracts.</p>
        </div>
        <div class="flex items-center space-x-3 mt-4 md:mt-0 w-full md:w-auto">
            <div class="relative w-full md:w-64">
                <input value="@searchTerm" @oninput="HandleSearchTermChange"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
                    placeholder="Search Username, Email, or Role..." />
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <button class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                @onclick="AddUser">
                <i class="fas fa-plus"></i> Add User
            </button>
        </div>
    </div>

    @* --- USER TABLE --- *@
    @if (Loading)
    {
        <div class="col-span-full text-center py-10 text-gray-500">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p class="text-lg">Loading users...</p>
        </div>
    }
    else
    {
        <div class="overflow-x-auto rounded-xl shadow-md border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-b from-red-700 to-black">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Username</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var u in PagedUsers)
                    {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">@u.UserName</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">@u.Email</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">@u.Role?.RoleName</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="@(u.IsActive ? "bg-green-100 text-green-700 px-2 py-1 rounded-full" : "bg-red-100 text-red-700 px-2 py-1 rounded-full")">
                                    @(u.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-100 transition"
                                    @onclick="() => ShowDetail(u)">
                                    <i class="fas fa-eye mr-1"></i> Detail
                                </button>
                                <button class="text-indigo-600 hover:text-indigo-900 p-2 rounded-lg hover:bg-indigo-100 transition"
                                    @onclick="() => EditUser(u)">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button class="text-red-600 hover:text-red-900 p-2 rounded-lg hover:bg-red-100 transition"
                                    @onclick="() => ConfirmDelete(u.Id, u.UserName)">
                                    <i class="fas fa-trash-alt mr-1"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (!FilteredUsers.Any() && !Loading)
        {
            <div class="col-span-full text-center py-10 text-gray-500">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p class="text-lg">No Users found.</p>
            </div>
        }
    }

    @* --- PAGINATION --- *@
    @if (FilteredUsers.Any() && !Loading && TotalPages > 1)
    {
        <div class="mt-8 flex justify-between items-center p-4 bg-gray-50 rounded-xl shadow-inner">
            <span class="text-sm text-gray-600">
                Showing <strong>@((CurrentPage - 1) * PageSize + 1)</strong> to <strong>@(Math.Min(CurrentPage * PageSize, FilteredUsers.Count()))</strong> of <strong>@FilteredUsers.Count()</strong> entries
            </span>
            <div class="flex space-x-2">
                <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == 1 ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                    @onclick="() => ChangePage(CurrentPage - 1)" disabled="@(CurrentPage == 1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                @for (int i = 1; i <= TotalPages; i++)
                {
                    var pageNumber = i;
                    <button class="px-4 py-2 text-sm rounded-lg font-medium @(i == CurrentPage ? "bg-blue-600 text-white shadow-md" : "bg-white hover:bg-blue-50 border text-gray-700")"
                        @onclick="() => ChangePage(pageNumber)">@i</button>
                }
                <button class="px-4 py-2 text-sm rounded-lg border @(CurrentPage == TotalPages ? "bg-gray-200 text-gray-500 cursor-not-allowed" : "bg-white hover:bg-gray-100 text-gray-700")"
                    @onclick="() => ChangePage(CurrentPage + 1)" disabled="@(CurrentPage == TotalPages)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    }

    @* --- ADD/EDIT/DETAIL MODAL --- *@
    @if (ShowModal)
    {
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ease-out">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl relative animate-zoom-in">
                <div class="absolute inset-0 flex justify-center items-center pointer-events-none">
                    <img src="assets/images/mock.png" class="max-w-[70%] max-h-[70%] opacity-30" alt="watermark">
                </div>
                <div class="border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">
                        @if (ModalMode == "Detail")
                        {
                            <i class="fas fa-eye text-green-600 mr-2"></i>
                        }
                        else if (ModalMode == "Add")
                        {
                            <i class="fas fa-plus text-green-600 mr-2"></i>
                        }
                        else
                        {
                            <i class="fas fa-edit text-blue-600 mr-2"></i>
                        }
                        @ModalTitle
                    </h2>
                    <button class="text-gray-400 hover:text-gray-600" @onclick="() => ShowModal = false">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                @if (ModalMode == "Detail")
                {
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-700">
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900 border-b pb-2">Primary Info</h3>
                                <p><strong>Username:</strong> @SelectedUser.UserName</p>
                                <p><strong>Email:</strong> @SelectedUser.Email</p>
                                <p><strong>Role:</strong> @SelectedUser.Role?.RoleName</p>
                                <p><strong>Status:</strong> @(SelectedUser.IsActive ? "Active" : "Inactive")</p>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-xl font-semibold text-gray-900 border-b pb-2">Details & History</h3>
                                <p><strong>Created By:</strong> @SelectedUser.CreatedBy</p>
                                <p><strong>Created At:</strong> @SelectedUser.CreatedAt.ToShortDateString()</p>
                                <p><strong>Last Updated:</strong> @SelectedUser.UpdatedAt.ToShortDateString()</p>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold px-5 py-2 rounded-lg transition" @onclick="() => ShowModal = false">Close</button>
                        </div>
                    </div>
                }
                else
                {
                    <EditForm Model="@SelectedUser" OnValidSubmit="SaveUser" class="p-6">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Username</label>
                                <InputText class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedUser.UserName" placeholder="Username" />
                                <ValidationMessage For="@(() => SelectedUser.UserName)" />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Email</label>
                                <InputText type="email" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedUser.Email" placeholder="Email" />
                                <ValidationMessage For="@(() => SelectedUser.Email)" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Role</label>
                                <InputSelect class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="SelectedUser.RoleId">
                                    <option value="">Select Role</option>
                                    @foreach (var r in Roles)
                                    {
                                        <option value="@r.Id">@r.RoleName</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => SelectedUser.RoleId)" />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Password</label>
                                <InputText type="password" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:border-blue-500" @bind-Value="Password" placeholder="Password" />
                                @if (SelectedUser.Id == 0)
                                {
                                    <ValidationMessage For="@(() => Password)" />
                                }
                            </div>
                        </div>
                        <div class="mb-4 flex gap-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Status</label>
                                <InputCheckbox class="mr-2" @bind-Value="SelectedUser.IsActive" /> Active
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1">Blocked</label>
                                <InputCheckbox class="mr-2" @bind-Value="SelectedUser.IsBlocked" /> Blocked
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3 border-t pt-4">
                            <button type="button" class="bg-red-700 hover:bg-red-800 text-white font-semibold px-5 py-2 rounded-lg transition flex items-center gap-2" @onclick="() => ShowModal = false">
                                <i class="fas fa-ban"></i> Cancel
                            </button>
                            <button type="submit" class="bg-green-700 hover:bg-green-800 text-white font-semibold px-5 py-2 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-save"></i> Save User
                            </button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    }

    @* --- CONFIRMATION MODAL --- *@
    @if (ShowConfirmModal)
    {
        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 animate-slide-up">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2 text-red-600">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Delete
                </h3>
                <p class="text-gray-700 mb-6">@ConfirmMessage</p>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium" @onclick="CancelDelete">Cancel</button>
                    <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium" @onclick="DeleteConfirmed">Delete</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private ToastContainer? toastContainer;
    private List<User> Users = new();
    private List<Role> Roles = new();
    private bool Loading = true;
    private string searchTerm = string.Empty;
    private bool ShowModal;
    private string ModalTitle = "";
    private string ModalMode = "";
    private User SelectedUser = new();
    private string Password = "";
    private bool ShowConfirmModal;
    private string ConfirmMessage = "";
    private int UserIdToDelete;
    private int CurrentPage = 1;
    private const int PageSize = 10;
    private int TotalPages => (int)Math.Ceiling(FilteredUsers.Count() / (double)PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        Roles = await RoleService.GetAllAsync();
        Loading = false;
    }

    private async Task LoadUsers()
    {
        Users = await UserService.GetAllAsync();
        CurrentPage = 1;
    }

    private IEnumerable<User> FilteredUsers =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? Users
            : Users.Where(u =>
                (u.UserName ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (u.Email ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (u.Role?.RoleName ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<User> PagedUsers =>
        FilteredUsers.Skip((CurrentPage - 1) * PageSize).Take(PageSize);

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
        }
    }

    private void HandleSearchTermChange(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        CurrentPage = 1;
        StateHasChanged();
    }

    private void AddUser()
    {
        SelectedUser = new User();
        Password = "";
        ModalMode = "Add";
        ModalTitle = "Add New User";
        ShowModal = true;
    }

    private void EditUser(User user)
    {
        SelectedUser = new User
        {
            Id = user.Id,
            UserName = user.UserName,
            Email = user.Email,
            RoleId = user.RoleId,
            Role = user.Role,
            PasswordHash = user.PasswordHash,
            PhotoData = user.PhotoData,
            IsActive = user.IsActive,
            IsBlocked = user.IsBlocked,
            IsDeleted = user.IsDeleted,
            CreatedBy = user.CreatedBy,
            CreatedAt = user.CreatedAt,
            UpdatedAt = user.UpdatedAt
        };
        Password = "";
        ModalMode = "Edit";
        ModalTitle = "Edit User";
        ShowModal = true;
    }

    private void ShowDetail(User user)
    {
        SelectedUser = new User
        {
            Id = user.Id,
            UserName = user.UserName,
            Email = user.Email,
            RoleId = user.RoleId,
            Role = user.Role,
            PasswordHash = user.PasswordHash,
            PhotoData = user.PhotoData,
            IsActive = user.IsActive,
            IsBlocked = user.IsBlocked,
            IsDeleted = user.IsDeleted,
            CreatedBy = user.CreatedBy,
            CreatedAt = user.CreatedAt,
            UpdatedAt = user.UpdatedAt
        };
        ModalMode = "Detail";
        ModalTitle = $"User Detail: {user.UserName}";
        ShowModal = true;
    }

    private void CancelDelete() => ShowConfirmModal = false;

    private void ConfirmDelete(int id, string name)
    {
        UserIdToDelete = id;
        ConfirmMessage = $"Are you sure you want to delete \"{name}\"?";
        ShowConfirmModal = true;
    }

    private async Task DeleteConfirmed()
    {
        try
        {
            ShowConfirmModal = false; // ⬅️ Tutup dulu biar UI langsung update
            StateHasChanged();     
            await UserService.DeleteAsync(UserIdToDelete);
            await LoadUsers();
            await ToastService.ShowInfo("User deleted successfully!");
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            ShowConfirmModal = false;
        }
    }

    private async Task SaveUser()
    {
        if (string.IsNullOrWhiteSpace(SelectedUser.UserName))
        {
            await ToastService.ShowWarning("Username is required.");
            return;
        }

        if (SelectedUser.Id == 0 && string.IsNullOrWhiteSpace(Password))
        {
            await ToastService.ShowWarning("Password is required for new users.");
            return;
        }

        try
        {
            if (SelectedUser.Id == 0)
            {
                // --- CALL API REGISTER ---
                var request = new RegisterRequest
                {
                    UserName = SelectedUser.UserName,
                    Email = SelectedUser.Email,
                    Password = Password,
                    RoleId = (int)SelectedUser.RoleId
                };

                var response = await Http.PostAsJsonAsync("api/auth/register", request);

                if (response.IsSuccessStatusCode)
                {
                    await ToastService.ShowSuccess("User added successfully!");
                    ShowModal = false;
                    await LoadUsers();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await ToastService.ShowError($"Failed to add user: {error}");
                }
            }
            else
            {
                // Update user lokal / domain
                if (!string.IsNullOrWhiteSpace(Password))
                    SelectedUser.PasswordHash = BCrypt.Net.BCrypt.HashPassword(Password);

                await UserService.UpdateAsync(SelectedUser);
                await ToastService.ShowInfo("User updated successfully!");
                ShowModal = false;
                await LoadUsers();
            }
        }
        catch (Exception ex)
        {
            await ToastService.ShowError($"Error: {ex.Message}");
        }
    }


    public class RegisterRequest
    {
        public string UserName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public int RoleId { get; set; }
    }

}
