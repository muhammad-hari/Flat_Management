@page "/visitor-analytics"
@using System.Globalization

<div class="p-6 space-y-6">
  <div class="bg-gradient-to-b from-red-700 to-black rounded-lg shadow-sm p-6 text-white">
    <h1 class="text-2xl font-bold">Occupant / Visitor Analytics</h1>
    <p class="text-sm text-gray-200 mt-1">Dummy charts (Bar, Line, Donut) built with Tailwind + SVG (no external libs).</p>
  </div>

  <div class="flex gap-4 items-center">
    <label class="text-sm font-medium">Dataset:</label>
    <button class="px-3 py-1 rounded @(SelectedDataset == DatasetType.All ? "bg-blue-600 text-white" : "bg-gray-100")"
            @onclick="() => ChangeDataset(DatasetType.All)">All</button>
    <button class="px-3 py-1 rounded @(SelectedDataset == DatasetType.Desktop ? "bg-blue-600 text-white" : "bg-gray-100")"
            @onclick="() => ChangeDataset(DatasetType.Desktop)">Desktop</button>
    <button class="px-3 py-1 rounded @(SelectedDataset == DatasetType.Mobile ? "bg-blue-600 text-white" : "bg-gray-100")"
            @onclick="() => ChangeDataset(DatasetType.Mobile)">Mobile</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Bar Chart Card -->
    <div class="bg-white rounded-lg shadow p-4">
      <h3 class="font-semibold mb-3">Visitors by Day (Bar)</h3>
      <div class="h-48 flex items-end">
        @* SVG Bar Chart *@
        <svg viewBox="0 0 600 200" class="w-full">
          @* grid lines *@
          @for (int i = 0; i <= 4; i++)
          {
              var y = 200 - (i * 40);
              <line x1="40" y1="@y" x2="590" y2="@y" stroke="#e5e7eb" stroke-width="1" />
              <span class="text-sm text-gray-500">+12% dibanding minggu lalu</span>

          }

          @* Bars *@
          @{
              var barCount = BarData.Count;
              var barWidth = 12;
              var gap = (520.0 - barCount * barWidth) / (barCount - 1);
              for (int i = 0; i < barCount; i++)
              {
                  var x = 40 + i * (barWidth + gap);
                  var height = (BarData[i] / MaxBarValue) * 160.0;
                  var y = 200 - height;
                  var color = BarColors[i % BarColors.Length];
          }
          }
          <svg viewBox="0 0 600 200" class="w-full h-48">
    @for (int i = 0; i < BarData.Count; i++)
    {
        var x = 40 + i * (12 + ((520.0 - BarData.Count * 12) / (BarData.Count - 1)));
        var height = (BarData[i] / MaxBarValue) * 160.0;
        var y = 200 - height;

        <rect x="@x" y="@y" width="12" height="@height" rx="3" fill="@BarColors[i % BarColors.Length]" />

        @((MarkupString)$"<text x='{x+6}' y='195' font-size='10' fill='#6b7280' text-anchor='middle'>{Labels[i]}</text>")
    }
</svg>
        </svg>
      </div>
    </div>

    <!-- Line Chart Card -->
    <div class="bg-white rounded-lg shadow p-4">
      <h3 class="font-semibold mb-3">Visitors Trend (Line)</h3>
      <div class="h-48">
        <svg viewBox="0 0 600 200" class="w-full">
          @* axes *@
          <line x1="40" y1="10" x2="40" y2="190" stroke="#e5e7eb" stroke-width="1" />
          <line x1="40" y1="190" x2="590" y2="190" stroke="#e5e7eb" stroke-width="1" />

          @* y grid *@
          @for (int i = 0; i <= 4; i++)
          {
              var y = 190 - i * 40;
              <line x1="40" y1="@y" x2="590" y2="@y" stroke="#f3f4f6" stroke-width="1" />
          }

          @* line path *@
          <path d="@LinePath" fill="none" stroke="#1f6feb" stroke-width="3" stroke-linejoin="round" stroke-linecap="round" />

          @* area fill (subtle) *@
          <path d="@AreaPath" fill="#bfdbfe" opacity="0.18" stroke="none" />

          @* points *@
          @for (int i = 0; i < LineData.Count; i++)
          {
              var x = 40 + (i * ((550.0) / (LineData.Count - 1)));
              var y = 190 - (LineData[i] / MaxLineValue) * 160.0;
              <circle cx="@x" cy="@y" r="3.5" fill="#1f6feb" stroke="#fff" stroke-width="1" />
          }
        </svg>
      </div>
    </div>

    <!-- Donut Chart Card -->
    <div class="bg-white rounded-lg shadow p-4">
      <h3 class="font-semibold mb-3">Visitor Source (Donut)</h3>
      <div class="flex items-center justify-center">
        <svg viewBox="0 0 200 200" class="w-40 h-40">
          <g transform="translate(100,100)">
            @{
                var total = DonutData.Sum();
                double startAngle = -90;
                for (int i = 0; i < DonutData.Count; i++)
                {
                    var value = DonutData[i];
                    var angle = value / total * 360.0;
                    var endAngle = startAngle + angle;
                    var path = ArcPath(40, startAngle, endAngle);
                    var fill = DonutColors[i % DonutColors.Length];
            }
            }
            @for (int i = 0; i < DonutData.Count; i++)
            {
                var value = DonutData[i];
                var angle = value / total * 360.0;
                var endAngle = (-90) + DonutData.Take(i + 1).Sum() / total * 360.0;
                var startAngleLocal = (-90) + (i == 0 ? 0 : DonutData.Take(i).Sum() / total * 360.0);
                <path d="@ArcPath(60, startAngleLocal, endAngle)" fill="@DonutColors[i % DonutColors.Length]" stroke="white" stroke-width="2"></path>
            }
            <circle r="36" fill="white"></circle>
            <text x="0" y="4" text-anchor="middle" font-size="12" fill="#374151">Total</text>
            <text x="0" y="20" text-anchor="middle" font-size="14" font-weight="600" fill="#111827">@total</text>
          </g>
        </svg>
      </div>

      <div class="mt-4 space-y-2">
        @for (int i = 0; i < DonutData.Count; i++)
        {
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded" style="background:@DonutColors[i]"></span>
                    <span class="text-sm">@DonutLabels[i]</span>
                </div>
                <div class="text-sm text-gray-600">@DonutData[i]</div>
            </div>
        }
      </div>
    </div>
  </div>
</div>

@code {
  enum DatasetType { All, Desktop, Mobile }
  private DatasetType SelectedDataset = DatasetType.All;

  // Dummy labels for X axis
  private List<string> Labels = new()
  {
      "Mon","Tue","Wed","Thu","Fri","Sat","Sun"
  };

  // Different dataset variants (dummy)
  private readonly List<int> AllBars = new() { 120, 150, 90, 180, 140, 160, 110 };
  private readonly List<int> DesktopBars = new() { 60, 80, 40, 70, 55, 60, 45 };
  private readonly List<int> MobileBars = new() { 60, 70, 50, 110, 85, 100, 65 };

  private readonly List<int> AllLine = new() { 30, 40, 20, 55, 45, 50, 32 };
  private readonly List<int> DesktopLine = new() { 15, 20, 9, 28, 22, 25, 16 };
  private readonly List<int> MobileLine = new() { 15, 20, 11, 27, 23, 25, 16 };

  private readonly List<int> AllDonut = new() { 45, 30, 15, 10 }; // direct, sponsor, aff, email
  private readonly List<int> DesktopDonut = new() { 20, 10, 5, 5 };
  private readonly List<int> MobileDonut = new() { 25, 20, 8, 5 };

  // visual colors
  private readonly string[] BarColors = new[] { "#1f6feb", "#16a34a", "#f59e0b", "#ef4444", "#8b5cf6", "#06b6d4", "#f97316" };
  private readonly string[] DonutColors = new[] { "#1f6feb", "#16bdca", "#f59e0b", "#e74694" };

  // bound data used by SVG rendering
  private List<int> BarData = new();
  private List<int> LineData = new();
  private List<int> DonutData = new();
  private List<string> DonutLabels = new() { "Direct", "Sponsor", "Affiliate", "Email" };

  protected override void OnInitialized()
  {
      ApplyDataset(SelectedDataset);
  }

  private void ChangeDataset(DatasetType ds)
  {
      SelectedDataset = ds;
      ApplyDataset(ds);
  }

  private void ApplyDataset(DatasetType ds)
  {
      if (ds == DatasetType.All)
      {
          BarData = AllBars.ToList();
          LineData = AllLine.ToList();
          DonutData = AllDonut.ToList();
      }
      else if (ds == DatasetType.Desktop)
      {
          BarData = DesktopBars.ToList();
          LineData = DesktopLine.ToList();
          DonutData = DesktopDonut.ToList();
      }
      else
      {
          BarData = MobileBars.ToList();
          LineData = MobileLine.ToList();
          DonutData = MobileDonut.ToList();
      }

      // recalc maxima for rendering
      MaxBarValue = Math.Max(1, BarData.Max());
      MaxLineValue = Math.Max(1, LineData.Max());

      // compute path strings for line chart
      ComputeLinePath();
      StateHasChanged();
  }

  private double MaxBarValue = 200;
  private double MaxLineValue = 60;

  // Line path & area path
  private string LinePath = "";
  private string AreaPath = "";

  private void ComputeLinePath()
  {
      if (LineData == null || LineData.Count == 0)
      {
          LinePath = "";
          AreaPath = "";
          return;
      }

      var points = new List<(double X, double Y)>();
      var width = 550.0;
      var height = 160.0;
      var left = 40.0;
      var top = 10.0;
      var step = width / (LineData.Count - 1);

      for (int i = 0; i < LineData.Count; i++)
      {
          var x = left + i * step;
          var y = 190 - (LineData[i] / MaxLineValue) * height;
          points.Add((x, y));
      }

      // path
      var sb = new System.Text.StringBuilder();
      sb.Append($"M {points[0].X.ToString(CultureInfo.InvariantCulture)} {points[0].Y.ToString(CultureInfo.InvariantCulture)} ");
      for (int i = 1; i < points.Count; i++)
      {
          sb.Append($"L {points[i].X.ToString(CultureInfo.InvariantCulture)} {points[i].Y.ToString(CultureInfo.InvariantCulture)} ");
      }
      LinePath = sb.ToString();

      // area path (down to baseline y=190)
      var sb2 = new System.Text.StringBuilder();
      sb2.Append($"M {points[0].X.ToString(CultureInfo.InvariantCulture)} {points[0].Y.ToString(CultureInfo.InvariantCulture)} ");
      for (int i = 1; i < points.Count; i++)
      {
          sb2.Append($"L {points[i].X.ToString(CultureInfo.InvariantCulture)} {points[i].Y.ToString(CultureInfo.InvariantCulture)} ");
      }
      sb2.Append($"L {points.Last().X.ToString(CultureInfo.InvariantCulture)} 190 L {points[0].X.ToString(CultureInfo.InvariantCulture)} 190 Z");
      AreaPath = sb2.ToString();
  }

  // Arc path for donut segment: radius, startAngle, endAngle in degrees
  private string ArcPath(double radius, double startAngle, double endAngle)
  {
      // convert degrees to radians
      double start = (Math.PI / 180.0) * startAngle;
      double end = (Math.PI / 180.0) * endAngle;

      // inner/outer radii for donut style
      var rOuter = radius;
      var rInner = radius - 24; // thickness

      // helper to get cartesian
      (double x, double y) P(double ang, double r) => (r * Math.Cos(ang), r * Math.Sin(ang));

      var (x1, y1) = P(start, rOuter);
      var (x2, y2) = P(end, rOuter);
      var (x3, y3) = P(end, rInner);
      var (x4, y4) = P(start, rInner);

      // large-arc-flag
      var largeArc = (endAngle - startAngle) > 180 ? 1 : 0;

      // path: outer arc, line to inner arc end, inner arc back, close
      var path = $"M {x1.ToString(CultureInfo.InvariantCulture)} {y1.ToString(CultureInfo.InvariantCulture)} " +
                 $"A {rOuter} {rOuter} 0 {largeArc} 1 {x2.ToString(CultureInfo.InvariantCulture)} {y2.ToString(CultureInfo.InvariantCulture)} " +
                 $"L {x3.ToString(CultureInfo.InvariantCulture)} {y3.ToString(CultureInfo.InvariantCulture)} " +
                 $"A {rInner} {rInner} 0 {largeArc} 0 {x4.ToString(CultureInfo.InvariantCulture)} {y4.ToString(CultureInfo.InvariantCulture)} Z";

      return path;
  }
}
