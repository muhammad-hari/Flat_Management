@page "/occupant-history"
@using MyApp.Core.Entities
@using MyApp.Core.Interfaces
@inject IOccupantHistoryRepository HistoryService
@inject IOccupantRepository OccupantService
@inject IRoomRepository RoomService

<div class="bg-gradient-to-b from-red-700 to-black rounded-lg shadow-sm p-6">
    <h2 class="text-2xl font-semibold text-white">Occupant History</h2>
    <p class="text-gray-200 mt-1">Track all occupant check-in, checkout, and transfer activities</p>
</div>

<div class="p-6 space-y-6">
    <!-- Summary Card -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-blue-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Data Histories</h2>
            <p class="text-2xl font-bold">@Histories?.Count()</p>
        </div>
        <div class="bg-green-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Active</h2>
            <p class="text-2xl font-bold">@Histories?.Count(u => u.Action != "Checkout")</p>
        </div>
        <div class="bg-red-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Inactive</h2>
            <p class="text-2xl font-bold">@Histories?.Count(u => u.Action == "Checkout")</p>
        </div>
        <div class="bg-purple-800 text-white p-4 rounded-2xl shadow-md">
            <h2 class="text-lg font-semibold">Total Transfer</h2>
            <p class="text-2xl font-bold">@Histories?.Count(u => u.Action == "Transfer")</p>
        </div>
    </div>
</div>

<div class="p-6 space-y-6">
    <input type="text" placeholder="Search by Occupant, Action, Room..." @bind="SearchTerm"
        class="px-4 py-2 w-1/3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" />

    <div class="overflow-x-auto mt-4">
        <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
            <thead class="bg-gradient-to-b from-red-700 to-black">
                <tr>
                    <th class="px-4 py-2 text-white">Occupant</th>
                    <th class="px-4 py-2 text-white">Action</th>
                    <th class="px-4 py-2 text-white">Date</th>
                    <th class="px-4 py-2 text-white">Room</th>
                    <th class="px-4 py-2 text-white">Notes</th>
                </tr>
            </thead>
            <tbody>
                @if (FilteredHistories.Any())
                {
                    @foreach (var h in FilteredHistories)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-2">@h.Occupant?.Employee?.Name</td>
                            <td class="px-4 py-2">
                                <span class="@GetActionClass(h.Action)">
                                    @h.Action
                                </span>
                            </td>
                            <td class="px-4 py-2">@h.CreatedAt.ToString("dd MMM yyyy HH:mm")</td>
                            <td class="px-4 py-2">@h.Room?.Name</td>
                            <td class="px-4 py-2">@h.Notes</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="py-12 text-center text-gray-400">No History Found</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<OccupantHistory> Histories = new();
    private string SearchTerm { get; set; } = "";

    private IEnumerable<OccupantHistory> FilteredHistories =>
    string.IsNullOrEmpty(SearchTerm)
    ? Histories
    : Histories.Where(h =>
    (h.Occupant?.Employee?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
    (h.Action?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
    (h.Room?.Name?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true) ||
    (h.Notes?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true)
    );

    protected override async Task OnInitializedAsync()
    {
        Histories = await HistoryService.GetAllAsync();
    }

    private string GetActionClass(string action) => action switch
    {
        "Checkout" => "text-red-600 font-semibold",
        "Transfer" => "text-yellow-600 font-semibold",
        "Checkin" => "text-green-600 font-semibold",
        _ => "text-gray-600"
    };
}