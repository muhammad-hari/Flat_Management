@page "/login"
@layout AuthLayout
@inject HttpClient Http
@inject NavigationManager NavManager
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedSessionStorage SessionStorage
@using MyApp.Shared.Models
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Text.Json

<div class="bg-gradient-to-b from-red-800  to-black">
    <div class="min-h-screen flex flex-col items-center justify-center py-6 px-4">
        <div class="max-w-[480px] w-full">
            <a href="javascript:void(0)">
                <img src="/assets/images/owl-logo.png" alt="logo" class="w-60 mb-8 mx-auto block" />
            </a>

            <div
                class="p-6 sm:p-8 rounded-2xl bg-gradient-to-b from-red-800  to-black border border-gray-200 shadow-sm">
                <h1 class="text-slate-900 text-white text-center text-3xl font-semibold">Sign in</h1>

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <p class="text-red-600 text-center mt-2">@ErrorMessage</p>
                }

                <div class="mt-12 space-y-6">
                    <div>
                        <label class="text-slate-900 text-sm text-white font-medium mb-2 block">User name</label>
                        <input @bind="UserName" type="text" placeholder="Enter user name"
                            class="w-full text-slate-900 text-xl border border-slate-300 px-4 py-3 rounded-md outline-blue-600" />
                    </div>

                    <div>
                        <label class="text-slate-900 text-sm text-white font-medium mb-2 block">Password</label>
                        <input @bind="Password" type="password" placeholder="Enter password"
                            class="w-full text-slate-900 text-xl border border-slate-300 px-4 py-3 rounded-md outline-blue-600" />
                    </div>

                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center">
                            <input id="remember-me" @bind="RememberMe" type="checkbox"
                                class="h-4 w-4 shrink-0 text-blue-600 focus:ring-blue-500 border-slate-300 rounded" />
                            <label for="remember-me" class="ml-3 block text-sm text-slate-900 text-white">Remember
                                me</label>
                        </div>
                    </div>

                    <div class="!mt-12">
                        <button @onclick="HandleLogin"
                            class="w-full py-2 px-4 text-[15px] font-medium tracking-wide rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer"
                            disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span class="flex items-center justify-center gap-2">
                                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                        fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"></path>
                                    </svg>
                                    Loading...
                                </span>
                            }
                            else
                            {
                                <span>Sign in</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<ToastContainer @ref="toastContainer" />


@code {
    private ToastContainer? toastContainer;
    private string UserName { get; set; } = "";
    private string Password { get; set; } = "";
    private bool RememberMe { get; set; } = false;
    private string? ErrorMessage;

    private bool IsLoading { get; set; } = false;

    private async Task HandleLogin()
    {
        ErrorMessage = null;
        IsLoading = true;

        var loginRequest = new LoginRequest
        {
            UserName = UserName,
            Password = Password
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/login", loginRequest);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (result != null)
                {
                    var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
                    var jwtToken = handler.ReadJwtToken(result.Token);
                    var claimsDict = jwtToken.Claims.ToDictionary(c => c.Type, c => c.Value);

                    await SessionStorage.SetAsync("jwt", result.Token);
                    await SessionStorage.SetAsync("claims", claimsDict);
                    toastContainer?.ShowToast("Login Successfully", "success");

                    NavManager.NavigateTo("/");
                }
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                ErrorMessage = error?.Message ?? "Wrong Password/User !";
                toastContainer?.ShowToast(ErrorMessage, "error");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
            toastContainer?.ShowToast(ErrorMessage, "error");
        }
        finally
        {
            IsLoading = false;
        }
    }

    @* private async Task HandleLogin()
    {
        ErrorMessage = null;

        var loginRequest = new LoginRequest
        {
            UserName = UserName,
            Password = Password
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/login", loginRequest);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (result != null)
                {
                    var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
                    var jwtToken = handler.ReadJwtToken(result.Token);
                    var claimsDict = jwtToken.Claims.ToDictionary(c => c.Type, c => c.Value);

                    await SessionStorage.SetAsync("jwt", result.Token);
                    await SessionStorage.SetAsync("claims", claimsDict);

                    NavManager.NavigateTo("/");
                }
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                ErrorMessage = error?.Message ?? "Login gagal";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    } *@

    public class LoginRequest
    {
        public string UserName { get; set; } = "";
        public string Password { get; set; } = "";
    }

    public class LoginResponse
    {
        public string Token { get; set; } = "";
    }

    public class ErrorResponse
    {
        public string Message { get; set; } = "";
    }
}