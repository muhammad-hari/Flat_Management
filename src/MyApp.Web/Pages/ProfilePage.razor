@page "/profile"
@using Blazored.Toast.Services
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using MyApp.Core.Entities
@using MyApp.Core.Models
@using MyApp.Web.Authentication
@inject UserManager<ApplicationUser> UserManager
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IToastService ToastService
@inject IJSRuntime JS
@attribute [Authorize]

<div class="bg-white rounded-lg shadow-sm p-6 max-w-3xl mx-auto">
    <div class="flex flex-col md:flex-row gap-8">
        <!-- Profile Photo Section -->
        <div class="flex flex-col items-center space-y-4">
            <div class="relative">
                <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-gray-200">
                    @if (string.IsNullOrEmpty(photoUrl))
                    {
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                            <i class="fas fa-user text-4xl text-gray-400"></i>
                        </div>
                    }
                    else
                    {
                        <img src="@photoUrl" alt="Profile" class="w-full h-full object-cover" />
                    }
                </div>
                <label for="photoInput" class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-2 cursor-pointer hover:bg-blue-600 transition-colors">
                    <i class="fas fa-camera"></i>
                    <InputFile id="photoInput" OnChange="HandlePhotoSelected" class="hidden" accept="image/*" />
                </label>
            </div>
            @if (!string.IsNullOrEmpty(photoUrl))
            {
                <button @onclick="RemovePhoto" class="text-sm text-red-500 hover:text-red-600">
                    Remove Photo
                </button>
            }
        </div>

        <!-- Profile Information Section -->
        <div class="flex-1">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Profile Information</h2>
            
            <EditForm Model="model" OnValidSubmit="HandleValidSubmit" class="space-y-6">
                <DataAnnotationsValidator />

                <!-- Username (Read-only) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" value="@model.Username" readonly 
                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600" />
                </div>

                <!-- Full Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <InputText @bind-Value="model.FullName" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
                    <ValidationMessage For="@(() => model.FullName)" class="text-sm text-red-500" />
                </div>

                <!-- Email (Read-only) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" value="@model.Email" readonly 
                           class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600" />
                </div>

                <!-- Phone Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <InputText @bind-Value="model.PhoneNumber" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500" />
                    <ValidationMessage For="@(() => model.PhoneNumber)" class="text-sm text-red-500" />
                </div>

                <!-- Roles (Read-only) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Roles</label>
                    <div class="flex flex-wrap gap-2">
                        @foreach (var role in model.Roles ?? new List<string>())
                        {
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                @role
                            </span>
                        }
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" 
                            disabled="@isProcessing"
                            class="@($"px-4 py-2 rounded-lg focus:outline-none focus:ring-2 transition-all {(isProcessing ? "bg-blue-400 cursor-not-allowed" : "bg-blue-600 hover:bg-blue-700")} text-white focus:ring-blue-500/50 inline-flex items-center")">
                        @if (isProcessing)
                        {
                            <div class="inline-flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Processing...
                            </div>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<ToastContainer />

@code {
    private ProfileModel model = new();
    private bool isProcessing;
    private string? photoUrl;
    private byte[]? photoData;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user != null)
        {
            model = new ProfileModel
            {
                Username = user.UserName ?? "",
                Email = user.Email ?? "",
                FullName = user.FullName ?? "",
                PhoneNumber = user.PhoneNumber ?? "",
                Roles = await UserManager.GetRolesAsync(user)
            };
            photoUrl = user.PhotoUrl; // Assuming you'll add this property to ApplicationUser
        }
    }

    private async Task HandleValidSubmit()
    {
        if (isProcessing) return;

        try
        {
            isProcessing = true;
            StateHasChanged();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);
            
            if (user != null)
            {
                user.FullName = model.FullName;
                user.PhoneNumber = model.PhoneNumber;
                
                if (photoData != null)
                {
                    user.PhotoUrl = photoUrl;
                    user.PhotoData = photoData;
                }
                else if (photoUrl == null)
                {
                    user.PhotoUrl = null;
                    user.PhotoData = null;
                }

                // Add small delay to show loading state
                await Task.Delay(500);

                var result = await UserManager.UpdateAsync(user);
                if (result.Succeeded)
                {
                    // Update the session to reflect changes
                    await AuthStateProvider.GetUserSessionAsync();
                    
                    // Show success toast with delay
                    await Task.Delay(300);
                    ToastService.ShowSuccess("Profile updated successfully!");
                }
                else
                {
                    var errors = string.Join(", ", result.Errors.Select(e => e.Description));
                    ToastService.ShowError($"Failed to update profile: {errors}");
                }
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError("An error occurred while updating your profile.");
            Console.WriteLine($"Profile update error: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task HandlePhotoSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                var resizedImage = await file.RequestImageFileAsync("image/jpeg", 800, 800);
                photoData = new byte[resizedImage.Size];
                await resizedImage.OpenReadStream().ReadAsync(photoData);
                photoUrl = $"data:image/jpeg;base64,{Convert.ToBase64String(photoData)}";
                StateHasChanged();
                
                // Add success toast for photo upload
                ToastService.ShowSuccess("Photo uploaded successfully!");
            }
            catch (Exception ex)
            {
                ToastService.ShowError("Failed to process image. Please try again.");
                Console.WriteLine($"Photo upload error: {ex.Message}");
            }
        }
    }

    private async Task RemovePhoto()
    {
        try
        {
            photoUrl = null;
            photoData = null;
            StateHasChanged();
            
            // Add success toast for photo removal
            ToastService.ShowSuccess("Photo removed successfully!");
        }
        catch (Exception ex)
        {
            ToastService.ShowError("Failed to remove photo. Please try again.");
            Console.WriteLine($"Photo removal error: {ex.Message}");
        }
    }
}